<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetroAvia - Gallery Game Boy</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            /* Palette colori più professionale e minimal */
            --bg-primary: #0f0f0f;
            --bg-secondary: #161616;
            --bg-tertiary: #1e1e1e;
            --bg-card: #1a1a1a;
            --bg-card-hover: #242424;
            --bg-glass: rgba(255, 255, 255, 0.03);
            --bg-glass-strong: rgba(255, 255, 255, 0.06);
            --bg-overlay: rgba(0, 0, 0, 0.85);
            
            /* Accenti più sobri e professionali */
            --accent-primary: #3b82f6;
            --accent-secondary: #10b981;
            --accent-tertiary: #f59e0b;
            --accent-error: #ef4444;
            --accent-warning: #f97316;
            --accent-info: #06b6d4;
            
            /* Testi più leggibili */
            --text-primary: #f8fafc;
            --text-secondary: #e2e8f0;
            --text-muted: #94a3b8;
            --text-dim: #64748b;
            
            /* Bordi più sottili */
            --border-primary: #334155;
            --border-secondary: rgba(255, 255, 255, 0.08);
            --border-accent: rgba(59, 130, 246, 0.3);
            
            /* Ombre più professionali */
            --shadow-primary: rgba(0, 0, 0, 0.25);
            --shadow-secondary: rgba(0, 0, 0, 0.15);
            --shadow-accent: rgba(59, 130, 246, 0.25);
            
            /* Gradienti più eleganti */
            --gradient-primary: linear-gradient(135deg, var(--accent-primary), #2563eb);
            --gradient-secondary: linear-gradient(135deg, var(--accent-secondary), #059669);
            --gradient-glass: linear-gradient(135deg, var(--bg-glass), var(--bg-glass-strong));
            --gradient-card: linear-gradient(135deg, var(--bg-card), rgba(26, 26, 26, 0.95));
            
            /* Nuovo gradiente per lo sfondo del titolo */
            --gradient-hero-bg: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 25%, #1d4ed8 50%, #2563eb 75%, #1e40af 100%);
            
            /* Transizioni più fluide */
            --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Border radius più moderni */
            --border-radius-sm: 6px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 16px;
            --border-radius-2xl: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
            font-feature-settings: 'liga', 'kern';
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Background più sottile e professionale */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 25% 25%, rgba(59, 130, 246, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(16, 185, 129, 0.04) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* Scrollbar più elegante */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { 
            background: var(--bg-secondary); 
            border-radius: var(--border-radius-sm);
        }
        ::-webkit-scrollbar-thumb { 
            background: var(--gradient-primary);
            border-radius: var(--border-radius-sm);
            transition: var(--transition-normal);
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--gradient-secondary);
        }

        /* Header con sfondo gradiente blu */
        .header {
            background: var(--gradient-glass);
            -webkit-backdrop-filter: blur(20px) saturate(1.2);
            backdrop-filter: blur(20px) saturate(1.2);
            border-bottom: 1px solid var(--border-secondary);
            padding: 4rem 0 3rem;
            text-align: center;
            position: relative;
        }

        /* Sfondo gradiente blu dietro il titolo */
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-hero-bg);
            opacity: 0.15;
            z-index: -1;
        }

        .header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, transparent 0%, rgba(15, 15, 15, 0.8) 100%);
            z-index: -1;
        }

        .header h1 {
            font-family: 'Inter', sans-serif;
            font-size: clamp(2.5rem, 6vw, 4rem);
            font-weight: 800;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #60a5fa, #93c5fd, #dbeafe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.04em;
            text-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
            position: relative;
        }

        .header .subtitle {
            font-size: clamp(1rem, 2.5vw, 1.25rem);
            color: var(--text-secondary);
            font-weight: 400;
            max-width: 600px;
            margin: 0 auto;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        /* Z-index migliorato per controlli admin */
        .admin-header-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-overlay);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-xl);
            padding: 12px 16px;
            z-index: 500;
            border: 1px solid var(--border-secondary);
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 32px var(--shadow-primary);
            transition: var(--transition-normal);
        }

        /* Miglioramento per nascondere controlli admin quando modal è aperto */
        body.modal-open .admin-header-controls {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.9);
            visibility: hidden;
        }

        .admin-header-controls .auth-status {
            padding: 8px 14px;
            border-radius: var(--border-radius-lg);
            font-size: 0.875rem;
            font-weight: 500;
            background: var(--bg-glass);
            border: 1px solid var(--border-secondary);
        }

        .admin-header-controls .auth-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .admin-header-controls .auth-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px var(--shadow-accent);
        }

        .admin-header-controls .auth-btn.logout {
            background: var(--gradient-secondary);
        }

        /* Sync status più discreto */
        .sync-status {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--bg-overlay);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-lg);
            padding: 8px 12px;
            font-size: 0.75rem;
            font-weight: 500;
            z-index: 500;
            border: 1px solid var(--border-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            transition: var(--transition-normal);
        }

        /* Miglioramento per nascondere sync status quando modal è aperto */
        body.modal-open .sync-status {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.9);
            visibility: hidden;
        }

        .sync-status.syncing { color: var(--accent-info); }
        .sync-status.synced { color: var(--accent-secondary); }
        .sync-status.error { color: var(--accent-error); }

        /* Search e filtri più puliti */
        .search-filters-container {
            background: var(--gradient-glass);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-secondary);
            padding: 2rem;
        }

        .search-filters-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .search-section {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex: 1;
        }

        .filters-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .gallery-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
        }

        .search-box {
            position: relative;
            max-width: 320px;
            min-width: 240px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 1px solid var(--border-secondary);
            border-radius: var(--border-radius-xl);
            background: var(--bg-glass);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: var(--transition-normal);
            font-family: inherit;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: var(--bg-glass-strong);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .search-input:focus + .search-icon {
            color: var(--accent-primary);
        }

        .sort-dropdown {
            padding: 12px 16px;
            border: 1px solid var(--border-secondary);
            border-radius: var(--border-radius-lg);
            background: var(--bg-glass);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition-normal);
            min-width: 140px;
        }

        .sort-dropdown:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .filter-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
        }

        /* Compare Bar - Nuovo sistema di confronto */
        .compare-bar {
            background: var(--gradient-glass);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-secondary);
            padding: 1rem 2rem;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .compare-bar.show {
            display: flex;
        }

        .compare-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .compare-count {
            background: var(--gradient-primary);
            color: white;
            padding: 4px 12px;
            border-radius: var(--border-radius-lg);
            font-weight: 600;
            font-size: 0.875rem;
        }

        .compare-actions {
            display: flex;
            gap: 1rem;
        }

        .compare-btn {
            background: var(--gradient-secondary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .compare-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .compare-btn.clear {
            background: var(--gradient-primary);
        }

        /* Statistiche più eleganti */
        .stats-bar {
            background: var(--gradient-glass);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            padding: 2rem;
            border-bottom: 1px solid var(--border-secondary);
        }

        .stats-container {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
            max-width: 800px;
            margin: 0 auto;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 1.5rem 1rem;
            border-radius: var(--border-radius-lg);
            background: var(--bg-glass);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-secondary);
            transition: var(--transition-normal);
            min-width: 120px;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            background: var(--bg-glass-strong);
            box-shadow: 0 8px 25px var(--shadow-secondary);
        }

        .stat-number {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.75rem;
            font-weight: 600;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        /* Navigazione più minimal */
        .nav-container {
            padding: 1.5rem 2rem;
            background: var(--gradient-glass);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-secondary);
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            max-width: 600px;
            margin: 0 auto;
        }

        .nav-tab {
            background: var(--bg-glass);
            color: var(--text-secondary);
            border: 1px solid var(--border-secondary);
            padding: 12px 20px;
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            border-color: var(--accent-primary);
            background: var(--bg-glass-strong);
        }

        .nav-tab.active {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--accent-primary);
            box-shadow: 0 4px 12px var(--shadow-accent);
        }

        /* User Controls - Nuova sezione per i controlli visitatore */
        .user-controls {
            padding: 1.5rem 2rem;
            background: var(--gradient-glass);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-secondary);
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .user-btn {
            background: var(--gradient-secondary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            justify-content: center;
        }

        .user-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .user-btn.compare-mode {
            background: linear-gradient(135deg, var(--accent-tertiary), #d97706);
        }

        /* Controlli admin più organizzati */
        .admin-controls {
            padding: 2rem;
            background: var(--gradient-glass);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-secondary);
            display: none;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .admin-controls.show {
            display: flex;
        }

        .admin-btn {
            background: var(--gradient-secondary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            justify-content: center;
        }

        .admin-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .admin-btn.edit-mode {
            background: linear-gradient(135deg, var(--accent-tertiary), #d97706);
        }

        .admin-btn.export {
            background: linear-gradient(135deg, var(--accent-info), #0891b2);
        }

        .admin-btn.import {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .admin-btn.clear {
            background: linear-gradient(135deg, var(--accent-error), #dc2626);
        }

        .admin-btn.sync {
            background: linear-gradient(135deg, var(--accent-primary), #2563eb);
        }

        /* Galleria più elegante */
        .gallery-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
        }

        .game-card {
            background: var(--gradient-card);
            -webkit-backdrop-filter: blur(15px);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-secondary);
            border-radius: var(--border-radius-xl);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition-slow);
            opacity: 0;
            animation: cardFadeIn 0.6s ease forwards;
            position: relative;
        }

        @keyframes cardFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .game-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px var(--shadow-primary);
            border-color: var(--accent-primary);
        }

        .game-card.selected {
            border-color: var(--accent-secondary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
        }

        /* Compare checkbox overlay */
        .compare-checkbox-overlay {
            position: absolute;
            top: 12px;
            left: 12px;
            z-index: 10;
            display: none;
        }

        .compare-mode .compare-checkbox-overlay {
            display: block;
        }

        .compare-checkbox {
            appearance: none;
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-secondary);
            border-radius: var(--border-radius-sm);
            background: var(--bg-overlay);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: var(--transition-normal);
            position: relative;
        }

        .compare-checkbox:checked {
            background: var(--accent-secondary);
            border-color: var(--accent-secondary);
        }

        .compare-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .game-image-container {
            position: relative;
            width: 100%;
            height: 280px;
            overflow: hidden;
            background: var(--bg-tertiary);
        }

        .game-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: var(--transition-slow);
        }

        .game-card:hover .game-image {
            transform: scale(1.05);
        }

        .game-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: var(--text-dim);
            background: var(--bg-tertiary);
        }

        .image-indicator {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--bg-overlay);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            color: var(--accent-secondary);
            padding: 4px 8px;
            border-radius: var(--border-radius-md);
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid var(--border-secondary);
        }

        .edit-controls {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 10;
            display: flex;
            gap: 8px;
        }

        .edit-btn {
            background: var(--bg-overlay);
            -webkit-backdrop-filter: blur(15px);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-secondary);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-normal);
            font-size: 0.875rem;
        }

        .edit-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            transform: scale(1.1);
        }

        .edit-btn.delete:hover {
            background: var(--accent-error);
            border-color: var(--accent-error);
        }

        .game-info {
            padding: 1.5rem;
        }

        .game-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            line-height: 1.3;
        }

        .game-model {
            color: var(--text-muted);
            margin-bottom: 1rem;
            font-size: 0.875rem;
            font-weight: 400;
        }

        .game-price {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'JetBrains Mono', monospace;
        }

        .game-date {
            position: absolute;
            bottom: 12px;
            right: 12px;
            background: var(--bg-overlay);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            color: var(--text-muted);
            padding: 4px 8px;
            border-radius: var(--border-radius-md);
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid var(--border-secondary);
        }

        /* Modal con z-index più alto e migliore gestione mobile */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-overlay);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem;
        }

        .modal-content {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--gradient-card);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-2xl);
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border-secondary);
            animation: modalSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 25px 50px var(--shadow-primary);
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Pulsante chiusura modal con z-index maggiore */
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.25rem;
            color: var(--text-primary);
            cursor: pointer;
            z-index: 1010;
            width: 40px;
            height: 40px;
            background: var(--bg-overlay);
            -webkit-backdrop-filter: blur(15px);
            backdrop-filter: blur(15px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-normal);
            border: 1px solid var(--border-secondary);
        }

        .modal-close:hover {
            background: var(--accent-error);
            color: white;
            transform: scale(1.1);
        }

        .modal-gallery {
            position: relative;
            width: 100%;
            height: 500px;
            overflow: hidden;
            background: var(--bg-tertiary);
        }

        .gallery-container-modal {
            display: flex;
            width: 100%;
            height: 100%;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .gallery-slide {
            min-width: 100%;
            height: 100%;
            position: relative;
        }

        .modal-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: zoom-in;
            transition: var(--transition-normal);
        }

        .modal-image:hover {
            transform: scale(1.02);
        }

        .modal-image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: var(--text-dim);
            background: var(--bg-tertiary);
        }

        .gallery-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-overlay);
            -webkit-backdrop-filter: blur(15px);
            backdrop-filter: blur(15px);
            color: white;
            border: 1px solid var(--border-secondary);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.125rem;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gallery-nav:hover {
            background: var(--accent-primary);
            transform: translateY(-50%) scale(1.1);
        }

        .gallery-nav.prev { left: 20px; }
        .gallery-nav.next { right: 20px; }

        .gallery-indicators {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }

        .gallery-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            cursor: pointer;
            transition: var(--transition-normal);
        }

        .gallery-dot.active,
        .gallery-dot:hover {
            background: var(--accent-primary);
            transform: scale(1.2);
        }

        .gallery-counter {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--bg-overlay);
            -webkit-backdrop-filter: blur(15px);
            backdrop-filter: blur(15px);
            color: white;
            padding: 8px 12px;
            border-radius: var(--border-radius-lg);
            font-size: 0.875rem;
            font-weight: 600;
            border: 1px solid var(--border-secondary);
        }

        /* Zoom Button per le immagini */
        .zoom-button {
            position: absolute;
            top: 20px;
            right: 80px;
            background: var(--bg-overlay);
            -webkit-backdrop-filter: blur(15px);
            backdrop-filter: blur(15px);
            color: white;
            border: 1px solid var(--border-secondary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-normal);
            font-size: 1rem;
            z-index: 20;
        }

        .zoom-button:hover {
            background: var(--accent-primary);
            transform: scale(1.1);
        }

        /* Zoom Modal */
        .zoom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            cursor: zoom-out;
        }

        .zoom-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 95vw;
            max-height: 95vh;
            object-fit: contain;
        }

        .zoom-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-normal);
            z-index: 2001;
        }

        .zoom-close:hover {
            background: var(--accent-error);
            transform: scale(1.1);
        }

        /* Compare Modal */
        .compare-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-overlay);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem;
        }

        .compare-content {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--gradient-card);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-2xl);
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border-secondary);
            animation: modalSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 25px 50px var(--shadow-primary);
        }

        .compare-header {
            padding: 2rem;
            border-bottom: 1px solid var(--border-secondary);
            text-align: center;
        }

        .compare-title {
            font-size: 2rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .compare-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .compare-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            padding: 2rem;
        }

        .compare-item {
            background: var(--bg-glass);
            border-radius: var(--border-radius-xl);
            overflow: hidden;
            border: 1px solid var(--border-secondary);
        }

        .compare-item-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: var(--bg-tertiary);
        }

        .compare-item-info {
            padding: 1.5rem;
        }

        .compare-item-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .compare-specs {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .compare-spec {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-secondary);
        }

        .compare-spec:last-child {
            border-bottom: none;
        }

        .compare-spec-label {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .compare-spec-value {
            color: var(--text-primary);
            font-size: 0.875rem;
            text-align: right;
            max-width: 60%;
        }

        .modal-info {
            padding: 2rem;
        }

        .modal-title {
            font-size: clamp(1.75rem, 4vw, 2.5rem);
            font-weight: 700;
            margin-bottom: 1.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }

        .spec-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .spec-item {
            background: var(--bg-glass);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            padding: 1.25rem;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-secondary);
            transition: var(--transition-normal);
        }

        .spec-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-secondary);
            border-color: var(--accent-primary);
        }

        .spec-label {
            font-weight: 600;
            color: var(--accent-secondary);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .spec-value {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.4;
        }

        .modal-price {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Form più puliti */
        .form-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-overlay);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem;
        }

        .form-content {
            max-width: 800px;
            margin: 0 auto;
            background: var(--gradient-card);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-2xl);
            padding: 2rem;
            position: relative;
            border: 1px solid var(--border-secondary);
            animation: modalSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 25px 50px var(--shadow-primary);
        }

        .form-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 2rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--accent-secondary);
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-secondary);
            border-radius: var(--border-radius-lg);
            background: var(--bg-glass);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: var(--transition-normal);
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: var(--bg-glass-strong);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-muted);
        }

        /* Upload area migliorata */
        .images-upload-container {
            border: 2px dashed var(--border-secondary);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            text-align: center;
            background: var(--bg-glass);
            transition: var(--transition-normal);
            position: relative;
        }

        .images-upload-container:hover {
            border-color: var(--accent-primary);
            background: var(--bg-glass-strong);
        }

        .images-upload-container.dragover {
            border-color: var(--accent-secondary);
            background: rgba(16, 185, 129, 0.1);
            transform: scale(1.02);
        }

        .images-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 2;
        }

        .upload-placeholder {
            pointer-events: none;
        }

        .upload-placeholder i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--accent-primary);
            opacity: 0.7;
        }

        .upload-placeholder div {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .upload-placeholder small {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .images-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .image-preview-item {
            position: relative;
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            aspect-ratio: 1;
            border: 2px solid var(--border-secondary);
            transition: var(--transition-normal);
        }

        .image-preview-item:hover {
            border-color: var(--accent-primary);
            transform: scale(1.05);
        }

        .image-preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-remove {
            position: absolute;
            top: 6px;
            right: 6px;
            background: var(--accent-error);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-normal);
        }

        .image-remove:hover {
            background: #ff6666;
            transform: scale(1.2);
        }

        .image-count {
            color: var(--accent-secondary);
            font-size: 0.875rem;
            margin-top: 0.75rem;
            font-weight: 500;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-secondary);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: var(--transition-normal);
            font-family: inherit;
            min-width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px var(--shadow-accent);
        }

        .btn-secondary {
            background: var(--bg-glass);
            color: var(--text-secondary);
            border: 1px solid var(--border-secondary);
        }

        .btn-secondary:hover {
            background: var(--bg-glass-strong);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        /* Stati vuoti */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
            grid-column: 1 / -1;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            opacity: 0.4;
            color: var(--accent-primary);
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .empty-state p {
            font-size: 1rem;
            line-height: 1.6;
        }

        /* Loading */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-overlay);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            flex-direction: column;
            gap: 1rem;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-secondary);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 1rem;
        }

        /* Auth modal */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-overlay);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .auth-content {
            background: var(--gradient-card);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-xl);
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            text-align: center;
            border: 1px solid var(--border-secondary);
            animation: modalSlideUp 0.3s ease;
            box-shadow: 0 25px 50px var(--shadow-primary);
        }

        .auth-content h3 {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .auth-content p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
        }

        .auth-content input {
            width: 100%;
            padding: 12px 16px;
            margin: 1rem 0;
            border: 1px solid var(--border-secondary);
            border-radius: var(--border-radius-lg);
            background: var(--bg-glass);
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: var(--transition-normal);
        }

        .auth-content input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .auth-content .btn {
            margin: 0.5rem;
            flex: 1;
        }

        /* Toast migliorati */
        .toast {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 16px 20px;
            border-radius: var(--border-radius-lg);
            font-weight: 500;
            font-size: 0.875rem;
            z-index: 2000;
            animation: slideInRight 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 350px;
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-secondary);
            box-shadow: 0 8px 25px var(--shadow-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.success {
            background: linear-gradient(135deg, var(--accent-secondary), #059669);
            color: white;
        }

        .toast.error {
            background: linear-gradient(135deg, var(--accent-error), #dc2626);
            color: white;
        }

        .toast.info {
            background: linear-gradient(135deg, var(--accent-info), #0891b2);
            color: white;
        }

        @keyframes slideInRight {
            from { 
                transform: translateX(100%); 
                opacity: 0; 
            }
            to { 
                transform: translateX(0); 
                opacity: 1; 
            }
        }

        /* MIGLIORAMENTI RESPONSIVE per mobile */
        @media (max-width: 768px) {
            .header {
                padding: 2rem 0;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }

            /* Migliore posizionamento dei controlli admin su mobile */
            .admin-header-controls {
                top: 15px;
                right: 15px;
                padding: 10px 14px;
                flex-direction: column;
                gap: 8px;
                transform: scale(0.85);
            }

            .admin-header-controls .auth-status {
                padding: 6px 10px;
                font-size: 0.75rem;
            }

            .admin-header-controls .auth-btn {
                padding: 6px 12px;
                font-size: 0.75rem;
            }

            .sync-status {
                top: 95px;
                right: 15px;
                transform: scale(0.85);
                font-size: 0.7rem;
                padding: 6px 10px;
            }

            .search-filters-wrapper {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .search-section {
                flex-direction: column;
                gap: 1rem;
            }

            .filters-section {
                justify-content: center;
            }

            .gallery {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            /* Modal più adatti per mobile con padding ridotto per evitare sovrapposizioni */
            .modal-content,
            .form-content,
            .compare-content {
                margin: 0.5rem;
                padding: 1rem;
                border-radius: var(--border-radius-xl);
            }

            .modal-gallery {
                height: 350px;
            }

            /* Pulsante chiusura modal più grande su mobile */
            .modal-close {
                top: 15px;
                right: 15px;
                width: 44px;
                height: 44px;
                font-size: 1.5rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .nav-tabs {
                flex-direction: column;
                gap: 8px;
            }
            
            .admin-controls {
                flex-direction: column;
                align-items: center;
                padding: 1.5rem;
            }
            
            .admin-btn {
                width: 100%;
                max-width: 250px;
            }

            .user-controls {
                flex-direction: column;
                align-items: center;
                padding: 1.5rem;
            }
            
            .user-btn {
                width: 100%;
                max-width: 250px;
            }
            
            .stats-container {
                gap: 1rem;
            }
            
            .gallery-nav {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .images-preview {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
                gap: 0.75rem;
            }
            
            .form-actions {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .btn {
                width: 100%;
            }

            .filter-label {
                display: none;
            }

            .toast {
                top: 20px;
                right: 20px;
                left: 20px;
                max-width: none;
            }

            /* IMPORTANTE - Quando modal è aperto su mobile, nascondi completamente i controlli */
            body.modal-open .admin-header-controls,
            body.modal-open .sync-status {
                display: none !important;
                opacity: 0 !important;
                visibility: hidden !important;
                pointer-events: none !important;
            }

            /* Assicura che il modal sia sempre sopra tutto su mobile */
            .modal,
            .form-modal,
            .auth-modal,
            .compare-modal,
            .zoom-modal {
                z-index: 9999 !important;
            }

            .modal-close,
            .zoom-close {
                z-index: 10000 !important;
            }

            /* Compare grid responsive */
            .compare-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .compare-bar {
                flex-direction: column;
                gap: 0.75rem;
                padding: 1rem;
            }

            .compare-actions {
                flex-direction: column;
                gap: 0.5rem;
                width: 100%;
                max-width: 250px;
            }
        }

        @media (max-width: 480px) {
            .gallery-container {
                padding: 2rem 1rem;
            }

            .search-filters-container {
                padding: 1rem;
            }

            .modal,
            .form-modal,
            .auth-modal,
            .compare-modal {
                padding: 0.5rem;
            }
            
            .modal-content,
            .form-content,
            .auth-content,
            .compare-content {
                padding: 1rem;
                margin: 0.25rem;
            }
            
            .modal-gallery {
                height: 300px;
            }
            
            .gallery-nav.prev { left: 10px; }
            .gallery-nav.next { right: 10px; }

            .admin-header-controls {
                top: 10px;
                right: 10px;
                transform: scale(0.8);
            }

            .sync-status {
                top: 90px;
                right: 10px;
                transform: scale(0.8);
            }

            /* Ancora più spazio dal top per il pulsante chiusura */
            .modal-close,
            .zoom-close {
                top: 10px;
                right: 10px;
                width: 48px;
                height: 48px;
                font-size: 1.75rem;
            }
        }

        /* Animazioni di caricamento più fluide */
        .fade-in {
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .slide-up {
            transform: translateY(20px);
            opacity: 0;
            animation: slideUp 0.5s ease forwards;
        }

        @keyframes slideUp {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Animazioni aggiuntive */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        @keyframes slideOutRight {
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="sync-status" id="syncStatus" style="display: none;">
        <i class="fas fa-cloud" id="syncIcon"></i>
        <span id="syncText">Inizializzazione...</span>
    </div>

    <div class="admin-header-controls" id="adminHeaderControls">
        <div class="auth-status" id="authStatus">
            <i class="fas fa-lock" id="authIcon"></i>
            <span id="authText">Modalità Visitatore</span>
        </div>
        <button class="auth-btn" id="authButton" onclick="showAuthModal()">
            <i class="fas fa-sign-in-alt"></i> Accedi
        </button>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Caricamento...</div>
    </div>

    <div class="auth-modal" id="authModal">
        <div class="auth-content">
            <h3>Accesso Admin</h3>
            <p>Inserisci la password per accedere alle funzionalità di amministrazione</p>
            <input type="password" id="authPassword" placeholder="Password admin" autocomplete="current-password">
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="closeAuthModal()">
                    <i class="fas fa-times"></i> Annulla
                </button>
                <button class="btn btn-primary" onclick="authenticate()">
                    <i class="fas fa-sign-in-alt"></i> Accedi
                </button>
            </div>
        </div>
    </div>

    <header class="header">
        <h1>RetroAvia</h1>
        <p class="subtitle">Galleria progetti Game Boy personalizzati · Creazioni uniche e modifiche professionali</p>
    </header>

    <div class="stats-bar">
        <div class="stats-container">
            <div class="stat-item" style="--i: 0">
                <div class="stat-number" id="totalGames">0</div>
                <div class="stat-label">Totale Progetti</div>
            </div>
            <div class="stat-item" style="--i: 1">
                <div class="stat-number" id="colorGames">0</div>
                <div class="stat-label">Game Boy Color</div>
            </div>
            <div class="stat-item" style="--i: 2">
                <div class="stat-number" id="advanceGames">0</div>
                <div class="stat-label">Game Boy Advance</div>
            </div>
            <div class="stat-item" style="--i: 3">
                <div class="stat-number" id="spGames">0</div>
                <div class="stat-label">Game Boy Advance SP</div>
            </div>
        </div>
    </div>

    <!-- Compare Bar -->
    <div class="compare-bar" id="compareBar">
        <div class="compare-info">
            <i class="fas fa-balance-scale"></i>
            <span>Modalità Confronto:</span>
            <div class="compare-count" id="compareCount">0</div>
            <span>progetti selezionati</span>
        </div>
        <div class="compare-actions">
            <button class="compare-btn" onclick="openCompareModal()" id="compareButton" disabled>
                <i class="fas fa-eye"></i> Confronta
            </button>
            <button class="compare-btn clear" onclick="clearCompareSelection()">
                <i class="fas fa-times"></i> Cancella
            </button>
        </div>
    </div>

    <div class="nav-container">
        <nav class="nav-tabs">
            <button class="nav-tab active" data-category="all" style="--i: 0">
                <i class="fas fa-gamepad"></i> Tutti
            </button>
            <button class="nav-tab" data-category="color" style="--i: 1">
                <i class="fas fa-palette"></i> Color
            </button>
            <button class="nav-tab" data-category="advance" style="--i: 2">
                <i class="fas fa-mobile-alt"></i> Advance
            </button>
            <button class="nav-tab" data-category="sp" style="--i: 3">
                <i class="fas fa-laptop"></i> Advance SP
            </button>
        </nav>
    </div>

    <!-- User Controls - Nuova sezione per i visitatori -->
    <div class="user-controls" id="userControls">
        <button class="user-btn" id="userCompareModeBtn" onclick="toggleCompareMode()">
            <i class="fas fa-balance-scale"></i> Confronta Progetti
        </button>
    </div>

    <div class="admin-controls" id="adminControls">
        <button class="admin-btn" onclick="openAddModal()">
            <i class="fas fa-plus"></i> Aggiungi
        </button>
        <button class="admin-btn" id="editModeBtn" onclick="toggleEditMode()">
            <i class="fas fa-edit"></i> Modifica
        </button>
        <button class="admin-btn sync" onclick="forceSyncData()">
            <i class="fas fa-sync-alt"></i> Sincronizza
        </button>
        <button class="admin-btn export" onclick="exportData()">
            <i class="fas fa-download"></i> Esporta
        </button>
        <button class="admin-btn import" onclick="importData()">
            <i class="fas fa-upload"></i> Importa
        </button>
        <button class="admin-btn clear" onclick="clearAllData()">
            <i class="fas fa-trash-alt"></i> Cancella
        </button>
    </div>

    <div class="search-filters-container">
        <div class="search-filters-wrapper">
            <div class="search-section">
                <h2 class="gallery-title" id="galleryTitle">Tutti i Progetti</h2>
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="Cerca progetti..." aria-label="Cerca progetti">
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>
            <div class="filters-section">
                <span class="filter-label">Ordina:</span>
                <select class="sort-dropdown" id="sortDropdown" aria-label="Ordina progetti" title="Ordinamento progetti">
                    <option value="date-desc">Più recenti</option>
                    <option value="date-asc">Più vecchi</option>
                    <option value="name-asc">Nome A-Z</option>
                    <option value="name-desc">Nome Z-A</option>
                    <option value="price-desc">Prezzo alto</option>
                    <option value="price-asc">Prezzo basso</option>
                </select>
            </div>
        </div>
    </div>

    <div class="gallery-container">
        <div class="gallery" id="gallery">
            <div class="empty-state">
                <i class="fas fa-gamepad"></i>
                <h3>Nessun progetto disponibile</h3>
                <p>I progetti RetroAvia appariranno qui una volta aggiunti</p>
            </div>
        </div>
    </div>

    <!-- Modal dettaglio progetto -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('detailModal')" title="Chiudi finestra dettagli">
                <i class="fas fa-times"></i>
            </span>
            <div class="modal-gallery" id="modalGallery">
                <div class="gallery-container-modal" id="galleryContainerModal">
                    <div class="gallery-slide">
                        <div class="modal-image-placeholder">
                            <i class="fas fa-gamepad"></i>
                        </div>
                    </div>
                </div>
                <button class="gallery-nav prev" id="prevBtn" onclick="changeSlide(-1)" title="Immagine precedente">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="gallery-nav next" id="nextBtn" onclick="changeSlide(1)" title="Immagine successiva">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <button class="zoom-button" onclick="openZoomModal()" title="Zoom immagine">
                    <i class="fas fa-search-plus"></i>
                </button>
                <div class="gallery-counter" id="galleryCounter">1 / 1</div>
                <div class="gallery-indicators" id="galleryIndicators"></div>
            </div>
            <div class="modal-info">
                <h2 class="modal-title" id="modalTitle">Progetto</h2>
                <div class="spec-grid" id="specGrid"></div>
                <div class="modal-price" id="modalPrice">€ 0</div>
            </div>
        </div>
    </div>

    <!-- Zoom Modal -->
    <div class="zoom-modal" id="zoomModal" onclick="closeZoomModal()">
        <button class="zoom-close" onclick="closeZoomModal()" title="Chiudi zoom">
            <i class="fas fa-times"></i>
        </button>
        <img class="zoom-content" id="zoomImage" src="" alt="Zoom">
    </div>

    <!-- Compare Modal -->
    <div class="compare-modal" id="compareModal">
        <div class="compare-content">
            <span class="modal-close" onclick="closeModal('compareModal')" title="Chiudi confronto">
                <i class="fas fa-times"></i>
            </span>
            <div class="compare-header">
                <h2 class="compare-title">Confronto Progetti</h2>
                <p class="compare-subtitle">Analizza le differenze tra i progetti selezionati</p>
            </div>
            <div class="compare-grid" id="compareGrid">
                <!-- I progetti da confrontare verranno inseriti qui -->
            </div>
        </div>
    </div>

    <!-- Modal form progetto -->
    <div class="form-modal" id="formModal">
        <div class="form-content">
            <span class="modal-close" onclick="closeModal('formModal')" title="Chiudi form">
                <i class="fas fa-times"></i>
            </span>
            <h2 class="form-title" id="formTitle">Aggiungi Progetto</h2>
            <form id="gameForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="gameName">
                            <i class="fas fa-gamepad"></i> Nome Progetto *
                        </label>
                        <input type="text" id="gameName" required placeholder="Game Boy Color Custom" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="gameCategory">
                            <i class="fas fa-tags"></i> Categoria *
                        </label>
                        <select id="gameCategory" required>
                            <option value="">Seleziona categoria</option>
                            <option value="color">Game Boy Color</option>
                            <option value="advance">Game Boy Advance</option>
                            <option value="sp">Game Boy Advance SP</option>
                        </select>
                    </div>
                </div>

                <div class="form-group full-width">
                    <label for="gameImages">
                        <i class="fas fa-images"></i> Immagini Progetto (Max 10) *
                    </label>
                    <div class="images-upload-container" id="imagesUploadContainer">
                        <input type="file" id="gameImages" class="images-input" accept="image/*" multiple>
                        <div class="upload-placeholder" id="uploadPlaceholder">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <div>Carica immagini</div>
                            <small>JPG, PNG · Max 5MB · Max 10 immagini</small>
                        </div>
                        <div class="images-preview" id="imagesPreview"></div>
                        <div class="image-count" id="imageCount">0 / 10 immagini</div>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="gamePrice">
                            <i class="fas fa-euro-sign"></i> Prezzo *
                        </label>
                        <input type="number" id="gamePrice" step="0.01" min="0" required placeholder="120.00" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="gameModel">
                            <i class="fas fa-microchip"></i> Modello Base *
                        </label>
                        <input type="text" id="gameModel" required placeholder="CGB-001" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="gameShell">
                            <i class="fas fa-mobile-alt"></i> Scocca
                        </label>
                        <input type="text" id="gameShell" placeholder="Trasparente custom" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="gameButtons">
                            <i class="fas fa-circle"></i> Pulsanti
                        </label>
                        <input type="text" id="gameButtons" placeholder="Custom colorati" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="gameLabel">
                            <i class="fas fa-tag"></i> Etichetta
                        </label>
                        <input type="text" id="gameLabel" placeholder="Personalizzata" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="gameBattery">
                            <i class="fas fa-battery-full"></i> Batteria
                        </label>
                        <input type="text" id="gameBattery" placeholder="Li-ion ricaricabile" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="gameAudio">
                            <i class="fas fa-volume-up"></i> Audio
                        </label>
                        <input type="text" id="gameAudio" placeholder="Speaker + amplificatore" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="gameDisplay">
                            <i class="fas fa-tv"></i> Display
                        </label>
                        <input type="text" id="gameDisplay" placeholder="IPS retroilluminato" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="gameLed">
                            <i class="fas fa-lightbulb"></i> Kit LED
                        </label>
                        <input type="text" id="gameLed" placeholder="RGB programmabile" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="gameBox">
                            <i class="fas fa-box"></i> Accessori
                        </label>
                        <input type="text" id="gameBox" placeholder="Box + manuale" autocomplete="off">
                    </div>
                </div>
                
                <div class="form-group full-width">
                    <label for="gameOther">
                        <i class="fas fa-plus-circle"></i> Note Aggiuntive
                    </label>
                    <textarea id="gameOther" rows="3" placeholder="Modifiche speciali, personalizzazioni..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('formModal')">
                        <i class="fas fa-times"></i> Annulla
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Salva
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configurazione e oggetti principali definiti PRIMA delle funzioni globali
        const CONFIG = {
            ADMIN_PASSWORD: 'RetroAvia2024!',
            MAX_FILE_SIZE: 5 * 1024 * 1024, // 5MB
            MAX_IMAGES: 10,
            SUPABASE_URL: 'https://moenkmmkpogjapsyiuat.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vZW5rbW1rcG9namFwc3lpdWF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0OTYyMTYsImV4cCI6MjA3MjA3MjIxNn0.RdFnDxJVIgESel9I6s84KRR3F6yPFL7rk0ycFP_q0pg',
            SYNC_TIMEOUT: 30000,
            RETRY_ATTEMPTS: 3,
            RETRY_DELAY: 2000,
            TOAST_DURATION: 4000,
            SEARCH_DEBOUNCE: 300,
            IMAGE_COMPRESSION: {
                quality: 0.6, // Ridotta da 0.8 per risparmiare spazio
                maxDimension: 1280 // Ridotta da 1920 per risparmiare spazio
            },
            STORAGE_LIMIT: 4 * 1024 * 1024 // 4MB limite approssimativo per localStorage
        };
        
        const STATE = {
            supabase: null,
            games: [],
            editMode: false,
            compareMode: false,
            currentCategory: 'all',
            editingId: null,
            isAuthenticated: false,
            searchQuery: '',
            sortBy: 'date-desc',
            currentSlide: 0,
            currentGameImages: [],
            uploadedImages: [],
            cloudSyncEnabled: true,
            isOnline: navigator.onLine,
            selectedGames: new Set() // Per il sistema di confronto
        };

        const Utils = {
            debounce: (func, wait) => {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            generateId: () => `game_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,

            formatDate: (dateString) => {
                return new Date(dateString).toLocaleDateString('it-IT', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            },

            formatPrice: (price) => {
                const num = parseFloat(price) || 0;
                return new Intl.NumberFormat('it-IT', {
                    style: 'currency',
                    currency: 'EUR'
                }).format(num);
            },

            sanitizeInput: (str) => {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },

            // Compressione immagini migliorata per ridurre occupazione localStorage
            compressImage: (file, quality = CONFIG.IMAGE_COMPRESSION.quality, maxDim = CONFIG.IMAGE_COMPRESSION.maxDimension) => {
                return new Promise((resolve, reject) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = () => {
                        let { width, height } = img;
                        
                        // Calcola le nuove dimensioni mantenendo l'aspect ratio
                        const ratio = Math.min(maxDim / width, maxDim / height);
                        if (ratio < 1) {
                            width *= ratio;
                            height *= ratio;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Prova prima con JPEG per file più piccoli
                        let result = canvas.toDataURL('image/jpeg', quality);
                        
                        // Se il file è ancora troppo grande, riduci ulteriormente
                        if (result.length > 300000) { // ~300KB
                            result = canvas.toDataURL('image/jpeg', quality * 0.7);
                        }
                        
                        resolve(result);
                    };
                    
                    img.onerror = reject;
                    img.src = URL.createObjectURL(file);
                });
            },

            fileToBase64: (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },

            async sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            },

            // Funzione per controllare la dimensione del localStorage
            getStorageSize: () => {
                let total = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        total += localStorage[key].length + key.length;
                    }
                }
                return total;
            },

            // Funzione per liberare spazio se necessario
            cleanupStorage: () => {
                const currentSize = Utils.getStorageSize();
                if (currentSize > CONFIG.STORAGE_LIMIT) {
                    // Rimuovi dati non essenziali se necessario
                    localStorage.removeItem('retroavia_last_sync');
                    console.warn('Storage cleanup eseguito');
                }
            }
        };

        const SupabaseManager = {
            initialize: () => {
                try {
                    if (window.supabase && window.supabase.createClient) {
                        STATE.supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY, {
                            auth: {
                                persistSession: false
                            },
                            realtime: {
                                params: {
                                    eventsPerSecond: 2
                                }
                            }
                        });
                        return true;
                    }
                } catch (error) {
                    console.error('Errore inizializzazione Supabase:', error);
                    return false;
                }
                return false;
            },

            async makeRequest(operation, retries = CONFIG.RETRY_ATTEMPTS) {
                if (!STATE.isOnline) {
                    throw new Error('Connessione offline');
                }

                let lastError;
                for (let attempt = 0; attempt < retries; attempt++) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), CONFIG.SYNC_TIMEOUT);
                        
                        const result = await operation();
                        clearTimeout(timeoutId);
                        
                        if (result.error) {
                            throw result.error;
                        }
                        
                        return result;
                    } catch (error) {
                        lastError = error;
                        console.warn(`Tentativo ${attempt + 1} fallito:`, error.message);
                        
                        if (attempt < retries - 1) {
                            await Utils.sleep(CONFIG.RETRY_DELAY * (attempt + 1));
                        }
                    }
                }
                
                throw lastError;
            },

            syncToCloud: async (notify = false) => {
                if (!STATE.cloudSyncEnabled || !STATE.supabase || !STATE.isOnline) {
                    UI.updateSyncStatus('local', 'Offline');
                    return false;
                }

                try {
                    UI.updateSyncStatus('syncing', 'Sincronizzazione...');
                    
                    await SupabaseManager.makeRequest(async () => {
                        return await STATE.supabase
                            .from('games')
                            .delete()
                            .neq('id', 'none');
                    });

                    if (STATE.games.length > 0) {
                        const gamesData = STATE.games.map(game => ({
                            id: game.id,
                            name: game.name,
                            category: game.category,
                            images: Array.isArray(game.images) ? game.images : [],
                            price: parseFloat(game.price) || 0,
                            model: game.model || '',
                            shell: game.shell || '',
                            buttons: game.buttons || '',
                            label: game.label || '',
                            battery: game.battery || '',
                            audio: game.audio || '',
                            display: game.display || '',
                            led: game.led || '',
                            box: game.box || '',
                            other: game.other || '',
                            created_at: game.createdAt,
                            updated_at: game.updatedAt || new Date().toISOString()
                        }));

                        await SupabaseManager.makeRequest(async () => {
                            return await STATE.supabase
                                .from('games')
                                .insert(gamesData);
                        });
                    }

                    localStorage.setItem('retroavia_last_sync', new Date().toISOString());
                    UI.updateSyncStatus('synced', `Sincronizzato (${STATE.games.length})`);
                    
                    if (notify) {
                        UI.showToast('Sincronizzazione completata con successo', 'success');
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Errore sincronizzazione:', error);
                    UI.updateSyncStatus('error', 'Errore sync');
                    
                    if (notify) {
                        const errorMsg = error.message.includes('fetch') ? 
                            'Problemi di connessione al server' : 
                            error.message;
                        UI.showToast(`Errore sincronizzazione: ${errorMsg}`, 'error');
                    }
                    return false;
                }
            },

            syncFromCloud: async () => {
                if (!STATE.cloudSyncEnabled || !STATE.supabase || !STATE.isOnline) {
                    UI.updateSyncStatus('local', 'Offline');
                    return false;
                }

                try {
                    UI.updateSyncStatus('syncing', 'Caricamento...');
                    
                    const result = await SupabaseManager.makeRequest(async () => {
                        return await STATE.supabase
                            .from('games')
                            .select('*')
                            .order('created_at', { ascending: false });
                    });

                    const cloudGames = result.data;

                    if (cloudGames && cloudGames.length > 0) {
                        const convertedGames = cloudGames.map(game => ({
                            id: game.id,
                            name: game.name,
                            category: game.category,
                            images: Array.isArray(game.images) ? game.images : [],
                            price: parseFloat(game.price) || 0,
                            model: game.model || '',
                            shell: game.shell || '',
                            buttons: game.buttons || '',
                            label: game.label || '',
                            battery: game.battery || '',
                            audio: game.audio || '',
                            display: game.display || '',
                            led: game.led || '',
                            box: game.box || '',
                            other: game.other || '',
                            createdAt: game.created_at,
                            updatedAt: game.updated_at
                        }));

                        if (STATE.games.length === 0 || convertedGames.length > STATE.games.length) {
                            STATE.games = convertedGames;
                            DataManager.saveLocal();
                            UI.renderGallery();
                            UI.updateStats();
                        }
                        
                        localStorage.setItem('retroavia_last_sync', new Date().toISOString());
                        UI.updateSyncStatus('synced', `Caricato (${STATE.games.length})`);
                    } else {
                        UI.updateSyncStatus('synced', 'Cloud vuoto');
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Errore caricamento da cloud:', error);
                    UI.updateSyncStatus('error', 'Errore caricamento');
                    return false;
                }
            }
        };

        const NetworkManager = {
            init: () => {
                window.addEventListener('online', () => {
                    STATE.isOnline = true;
                    if (STATE.isAuthenticated && STATE.cloudSyncEnabled && STATE.supabase) {
                        SupabaseManager.syncFromCloud();
                    }
                });

                window.addEventListener('offline', () => {
                    STATE.isOnline = false;
                    UI.updateSyncStatus('local', 'Offline');
                });
            }
        };

        // Gestione migliorata del localStorage con controllo quota
        const DataManager = {
            loadLocal: () => {
                try {
                    const saved = localStorage.getItem('retroavia_games');
                    if (saved) {
                        const parsedGames = JSON.parse(saved);
                        STATE.games = parsedGames.map(game => ({
                            id: game.id || Utils.generateId(),
                            name: game.name || 'Progetto',
                            category: game.category || 'color',
                            images: Array.isArray(game.images) ? game.images : [],
                            price: parseFloat(game.price) || 0,
                            model: game.model || '',
                            shell: game.shell || '',
                            buttons: game.buttons || '',
                            label: game.label || '',
                            battery: game.battery || '',
                            audio: game.audio || '',
                            display: game.display || '',
                            led: game.led || '',
                            box: game.box || '',
                            other: game.other || '',
                            createdAt: game.createdAt || new Date().toISOString(),
                            updatedAt: game.updatedAt || new Date().toISOString()
                        }));
                        
                        DataManager.sortGames();
                    }
                    
                    UI.renderGallery();
                    UI.updateStats();
                } catch (error) {
                    console.error('Errore caricamento locale:', error);
                    STATE.games = [];
                    UI.showToast('Errore caricamento dati locali', 'error');
                }
            },

            saveLocal: () => {
                try {
                    if (typeof(Storage) === "undefined") {
                        throw new Error('LocalStorage non supportato');
                    }
                    
                    // Controlla la dimensione prima del salvataggio
                    Utils.cleanupStorage();
                    
                    const dataToSave = JSON.stringify(STATE.games);
                    
                    // Controlla se supererebbe il limite
                    if (dataToSave.length > CONFIG.STORAGE_LIMIT) {
                        throw new Error('Dati troppo grandi per localStorage');
                    }
                    
                    localStorage.setItem('retroavia_games', dataToSave);
                    
                    const saved = localStorage.getItem('retroavia_games');
                    if (saved === dataToSave) {
                        return true;
                    } else {
                        throw new Error('Verifica post-salvataggio fallita');
                    }
                } catch (error) {
                    console.error('Errore salvataggio locale:', error);
                    
                    if (error.name === 'QuotaExceededError' || error.message.includes('quota') || error.message.includes('troppo grandi')) {
                        // Mostra il messaggio di errore solo agli admin autenticati
                        if (STATE.isAuthenticated) {
                            UI.showToast('Spazio insufficiente. Riduci il numero di immagini o attiva la sincronizzazione cloud.', 'error');
                        }
                        
                        // Prova a salvare nel cloud se possibile
                        if (STATE.cloudSyncEnabled && STATE.supabase && STATE.isOnline && STATE.isAuthenticated) {
                            SupabaseManager.syncToCloud(true);
                        }
                    } else {
                        // Altri errori mostrati solo agli admin
                        if (STATE.isAuthenticated) {
                            UI.showToast('Errore nel salvataggio locale', 'error');
                        }
                    }
                    return false;
                }
            },

            filterGames: () => {
                let filtered = STATE.currentCategory === 'all' ? 
                    [...STATE.games] : 
                    STATE.games.filter(g => g.category === STATE.currentCategory);
                
                if (STATE.searchQuery) {
                    const query = STATE.searchQuery.toLowerCase();
                    filtered = filtered.filter(game => 
                        game.name.toLowerCase().includes(query) ||
                        game.model.toLowerCase().includes(query) ||
                        (game.shell && game.shell.toLowerCase().includes(query)) ||
                        (game.buttons && game.buttons.toLowerCase().includes(query)) ||
                        (game.display && game.display.toLowerCase().includes(query))
                    );
                }
                
                return DataManager.applySorting(filtered);
            },

            applySorting: (games) => {
                const sortedGames = [...games];
                
                switch (STATE.sortBy) {
                    case 'date-desc':
                        return sortedGames.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    case 'date-asc':
                        return sortedGames.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    case 'name-asc':
                        return sortedGames.sort((a, b) => a.name.localeCompare(b.name));
                    case 'name-desc':
                        return sortedGames.sort((a, b) => b.name.localeCompare(a.name));
                    case 'price-desc':
                        return sortedGames.sort((a, b) => b.price - a.price);
                    case 'price-asc':
                        return sortedGames.sort((a, b) => a.price - b.price);
                    default:
                        return sortedGames;
                }
            },

            sortGames: () => {
                STATE.games = DataManager.applySorting(STATE.games);
            }
        };

        // Nuovo sistema di confronto progetti
        const CompareManager = {
            toggleGame: (gameId) => {
                if (STATE.selectedGames.has(gameId)) {
                    STATE.selectedGames.delete(gameId);
                } else {
                    if (STATE.selectedGames.size >= 6) { // Limite massimo 6 progetti
                        UI.showToast('Massimo 6 progetti per confronto', 'error');
                        return false;
                    }
                    STATE.selectedGames.add(gameId);
                }
                
                CompareManager.updateUI();
                return true;
            },

            updateUI: () => {
                const compareBar = document.getElementById('compareBar');
                const compareCount = document.getElementById('compareCount');
                const compareButton = document.getElementById('compareButton');
                
                const count = STATE.selectedGames.size;
                
                if (count > 0) {
                    compareBar.classList.add('show');
                    compareCount.textContent = count;
                    compareButton.disabled = count < 2;
                } else {
                    compareBar.classList.remove('show');
                    compareButton.disabled = true;
                }

                // Aggiorna gli checkbox
                document.querySelectorAll('.compare-checkbox').forEach(checkbox => {
                    const gameId = checkbox.dataset.gameId;
                    checkbox.checked = STATE.selectedGames.has(gameId);
                });

                // Aggiorna lo stile delle card
                document.querySelectorAll('.game-card').forEach(card => {
                    const gameId = card.dataset.gameId;
                    if (STATE.selectedGames.has(gameId)) {
                        card.classList.add('selected');
                    } else {
                        card.classList.remove('selected');
                    }
                });
            },

            clear: () => {
                STATE.selectedGames.clear();
                CompareManager.updateUI();
                UI.showToast('Selezione confronto cancellata', 'info');
            },

            openModal: () => {
                if (STATE.selectedGames.size < 2) {
                    UI.showToast('Seleziona almeno 2 progetti per confrontarli', 'error');
                    return;
                }

                const selectedGames = Array.from(STATE.selectedGames).map(id => 
                    STATE.games.find(g => g.id === id)
                ).filter(g => g);

                CompareManager.renderCompareModal(selectedGames);
                document.getElementById('compareModal').style.display = 'block';
                document.body.style.overflow = 'hidden';
                document.body.classList.add('modal-open');
            },

            renderCompareModal: (games) => {
                const compareGrid = document.getElementById('compareGrid');
                
                compareGrid.innerHTML = games.map(game => {
                    const specs = [
                        { label: 'Categoria', value: game.category === 'color' ? 'Game Boy Color' : 
                                                    game.category === 'advance' ? 'Game Boy Advance' : 
                                                    'Game Boy Advance SP' },
                        { label: 'Modello', value: game.model },
                        { label: 'Prezzo', value: Utils.formatPrice(game.price) },
                        { label: 'Scocca', value: game.shell || 'Non specificata' },
                        { label: 'Pulsanti', value: game.buttons || 'Standard' },
                        { label: 'Display', value: game.display || 'Standard' },
                        { label: 'Audio', value: game.audio || 'Standard' },
                        { label: 'Batteria', value: game.battery || 'Standard' },
                        { label: 'Kit LED', value: game.led || 'Nessuno' },
                        { label: 'Accessori', value: game.box || 'Nessuno' }
                    ];

                    const firstImage = game.images && game.images.length > 0 ? game.images[0] : null;
                    
                    return `
                        <div class="compare-item">
                            ${firstImage ? 
                                `<img src="${firstImage}" alt="${Utils.sanitizeInput(game.name)}" class="compare-item-image">` :
                                `<div class="compare-item-image" style="display: flex; align-items: center; justify-content: center; color: var(--text-dim); background: var(--bg-tertiary);">
                                    <i class="fas fa-gamepad" style="font-size: 3rem;"></i>
                                </div>`
                            }
                            <div class="compare-item-info">
                                <h3 class="compare-item-title">${Utils.sanitizeInput(game.name)}</h3>
                                <div class="compare-specs">
                                    ${specs.map(spec => `
                                        <div class="compare-spec">
                                            <span class="compare-spec-label">${spec.label}:</span>
                                            <span class="compare-spec-value">${Utils.sanitizeInput(spec.value)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        };

        const UI = {
            updateSyncStatus: (status, text) => {
                const syncStatus = document.getElementById('syncStatus');
                const syncIcon = document.getElementById('syncIcon');
                const syncText = document.getElementById('syncText');
                
                if (!syncStatus || !syncIcon || !syncText) return;
                
                syncStatus.style.display = STATE.isAuthenticated ? 'flex' : 'none';
                
                syncStatus.className = `sync-status ${status}`;
                syncText.textContent = text;
                
                switch(status) {
                    case 'syncing':
                        syncIcon.className = 'fas fa-sync-alt fa-spin';
                        break;
                    case 'synced':
                        syncIcon.className = 'fas fa-cloud-check';
                        break;
                    case 'error':
                        syncIcon.className = 'fas fa-cloud-exclamation';
                        break;
                    case 'local':
                        syncIcon.className = 'fas fa-hard-drive';
                        break;
                    default:
                        syncIcon.className = 'fas fa-cloud';
                }
            },

            updateAuthUI: () => {
                const elements = {
                    authStatus: document.getElementById('authStatus'),
                    authButton: document.getElementById('authButton'),
                    authIcon: document.getElementById('authIcon'),
                    authText: document.getElementById('authText'),
                    adminControls: document.getElementById('adminControls'),
                    userControls: document.getElementById('userControls'),
                    syncStatus: document.getElementById('syncStatus')
                };

                if (STATE.isAuthenticated) {
                    elements.authStatus.className = 'auth-status logged-in';
                    elements.authIcon.className = 'fas fa-unlock';
                    elements.authText.textContent = 'Admin';
                    elements.authButton.innerHTML = '<i class="fas fa-sign-out-alt"></i> Esci';
                    elements.authButton.className = 'auth-btn logout';
                    elements.adminControls.classList.add('show');
                    elements.userControls.style.display = 'none'; // Nascondi controlli utente in modalità admin
                    elements.syncStatus.style.display = 'flex';
                } else {
                    elements.authStatus.className = 'auth-status logged-out';
                    elements.authIcon.className = 'fas fa-lock';
                    elements.authText.textContent = 'Visitatore';
                    elements.authButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Accedi';
                    elements.authButton.className = 'auth-btn';
                    elements.adminControls.classList.remove('show');
                    elements.userControls.style.display = 'flex'; // Mostra controlli utente in modalità visitatore
                    elements.syncStatus.style.display = 'none';
                }
            },

            updateStats: () => {
                const total = STATE.games.length;
                const stats = {
                    total: total,
                    color: STATE.games.filter(g => g.category === 'color').length,
                    advance: STATE.games.filter(g => g.category === 'advance').length,
                    sp: STATE.games.filter(g => g.category === 'sp').length
                };

                Object.entries(stats).forEach(([key, value], index) => {
                    const element = document.getElementById(key === 'total' ? 'totalGames' : `${key}Games`);
                    if (element) {
                        setTimeout(() => {
                            UI.animateCounter(element, parseInt(element.textContent) || 0, value);
                        }, index * 100);
                    }
                });
            },

            animateCounter: (element, start, end, duration = 800) => {
                const range = end - start;
                const increment = range / (duration / 16);
                let current = start;
                
                const timer = setInterval(() => {
                    current += increment;
                    if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                        current = end;
                        clearInterval(timer);
                    }
                    element.textContent = Math.floor(current);
                }, 16);
            },

            switchCategory: (category, tabElement) => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                tabElement.classList.add('active');
                STATE.currentCategory = category;
                
                const titles = {
                    'all': 'Tutti i Progetti',
                    'color': 'Game Boy Color',
                    'advance': 'Game Boy Advance',
                    'sp': 'Game Boy Advance SP'
                };
                
                document.getElementById('galleryTitle').textContent = titles[category];
                UI.renderGallery();
            },

            renderGallery: () => {
                const gallery = document.getElementById('gallery');
                const filteredGames = DataManager.filterGames();

                // Aggiorna la classe per modalità confronto
                const galleryContainer = document.querySelector('.gallery-container');
                if (STATE.compareMode) {
                    galleryContainer.classList.add('compare-mode');
                } else {
                    galleryContainer.classList.remove('compare-mode');
                }

                if (filteredGames.length === 0) {
                    const message = STATE.searchQuery ? 
                        `Nessun risultato per "${STATE.searchQuery}"` : 
                        'Nessun progetto disponibile';
                    
                    gallery.innerHTML = `
                        <div class="empty-state fade-in">
                            <i class="fas fa-gamepad"></i>
                            <h3>${message}</h3>
                            <p>${STATE.searchQuery ? 'Prova con altri termini di ricerca' : 'I progetti RetroAvia appariranno qui una volta aggiunti'}</p>
                        </div>
                    `;
                    return;
                }

                gallery.innerHTML = filteredGames.map((game, index) => {
                    const date = Utils.formatDate(game.createdAt);
                    const imageCount = game.images ? game.images.length : 0;
                    const firstImage = imageCount > 0 ? game.images[0] : null;
                    const price = Utils.formatPrice(game.price);
                    const isSelected = STATE.selectedGames.has(game.id);
                    
                    return `
                        <div class="game-card ${isSelected ? 'selected' : ''}" 
                             data-game-id="${game.id}"
                             onclick="handleCardClick('${game.id}', event)" 
                             style="--i: ${index}; animation-delay: ${index * 0.05}s">
                            
                            ${STATE.compareMode ? `
                                <div class="compare-checkbox-overlay">
                                    <input type="checkbox" class="compare-checkbox" 
                                           data-game-id="${game.id}" 
                                           ${isSelected ? 'checked' : ''}
                                           onchange="toggleCompare('${game.id}')"
                                           onclick="event.stopPropagation()">
                                </div>
                            ` : ''}
                            
                            ${STATE.editMode ? `
                                <div class="edit-controls">
                                    <button class="edit-btn" onclick="event.stopPropagation(); editGame('${game.id}')" title="Modifica">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="edit-btn delete" onclick="event.stopPropagation(); deleteGame('${game.id}')" title="Elimina">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            ` : ''}
                            
                            <div class="game-image-container">
                                ${firstImage ? 
                                    `<img src="${firstImage}" alt="${Utils.sanitizeInput(game.name)}" class="game-image" loading="lazy">` : 
                                    `<div class="game-placeholder"><i class="fas fa-gamepad"></i></div>`
                                }
                                ${imageCount > 1 ? `<div class="image-indicator">${imageCount} foto</div>` : ''}
                                <div class="game-date">${date}</div>
                            </div>
                            <div class="game-info">
                                <div class="game-title">${Utils.sanitizeInput(game.name)}</div>
                                <div class="game-model">${Utils.sanitizeInput(game.model)}</div>
                                <div class="game-price">${price}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Aggiorna UI confronto dopo il rendering
                CompareManager.updateUI();
            },

            showDetails: (id) => {
                if (STATE.editMode || STATE.compareMode) return;
                
                const game = STATE.games.find(g => g.id === id);
                if (!game) return;

                document.body.classList.add('modal-open');

                document.getElementById('modalTitle').textContent = game.name;
                document.getElementById('modalPrice').textContent = Utils.formatPrice(game.price);
                
                STATE.currentGameImages = Array.isArray(game.images) ? game.images : [];
                STATE.currentSlide = 0;
                UI.updateModalGallery();

                const specs = [
                    { label: 'Modello', value: game.model, icon: 'microchip' },
                    { label: 'Scocca', value: game.shell, icon: 'mobile-alt' },
                    { label: 'Pulsanti', value: game.buttons, icon: 'circle' },
                    { label: 'Etichetta', value: game.label, icon: 'tag' },
                    { label: 'Batteria', value: game.battery, icon: 'battery-full' },
                    { label: 'Audio', value: game.audio, icon: 'volume-up' },
                    { label: 'Display', value: game.display, icon: 'tv' },
                    { label: 'LED', value: game.led, icon: 'lightbulb' },
                    { label: 'Accessori', value: game.box, icon: 'box' },
                    { label: 'Note', value: game.other, icon: 'plus-circle' }
                ].filter(spec => spec.value && spec.value.trim() !== '');

                document.getElementById('specGrid').innerHTML = specs.map(spec => `
                    <div class="spec-item slide-up" style="animation-delay: ${Math.random() * 0.3}s">
                        <div class="spec-label">
                            <i class="fas fa-${spec.icon}"></i> ${spec.label}
                        </div>
                        <div class="spec-value">${Utils.sanitizeInput(spec.value)}</div>
                    </div>
                `).join('');

                document.getElementById('detailModal').style.display = 'block';
                document.body.style.overflow = 'hidden';
            },

            updateModalGallery: () => {
                const container = document.getElementById('galleryContainerModal');
                const counter = document.getElementById('galleryCounter');
                const indicators = document.getElementById('galleryIndicators');
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                const zoomBtn = document.querySelector('.zoom-button');
                
                const showControls = STATE.currentGameImages.length > 1;
                if (prevBtn) prevBtn.style.display = showControls ? 'flex' : 'none';
                if (nextBtn) nextBtn.style.display = showControls ? 'flex' : 'none';
                if (indicators) indicators.style.display = showControls ? 'flex' : 'none';
                
                // Mostra pulsante zoom solo se ci sono immagini
                if (zoomBtn) {
                    zoomBtn.style.display = STATE.currentGameImages.length > 0 ? 'flex' : 'none';
                }
                
                if (STATE.currentGameImages.length === 0) {
                    container.innerHTML = `
                        <div class="gallery-slide">
                            <div class="modal-image-placeholder">
                                <i class="fas fa-gamepad"></i>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = STATE.currentGameImages.map((img, index) => `
                    <div class="gallery-slide">
                        <img src="${img}" alt="Game Boy ${index + 1}" class="modal-image" loading="lazy">
                    </div>
                `).join('');
                
                container.style.transform = `translateX(-${STATE.currentSlide * 100}%)`;
                
                if (counter) {
                    counter.textContent = `${STATE.currentSlide + 1} / ${STATE.currentGameImages.length}`;
                }
                
                if (indicators && showControls) {
                    indicators.innerHTML = STATE.currentGameImages.map((_, index) => `
                        <div class="gallery-dot ${index === STATE.currentSlide ? 'active' : ''}" 
                             onclick="goToSlide(${index})"></div>
                    `).join('');
                }
            },

            changeSlide: (direction) => {
                if (STATE.currentGameImages.length <= 1) return;
                STATE.currentSlide = (STATE.currentSlide + direction + STATE.currentGameImages.length) % STATE.currentGameImages.length;
                UI.updateModalGallery();
            },

            goToSlide: (index) => {
                if (index >= 0 && index < STATE.currentGameImages.length) {
                    STATE.currentSlide = index;
                    UI.updateModalGallery();
                }
            },

            showLoading: (text = 'Caricamento...') => {
                const loading = document.getElementById('loading');
                const loadingText = document.querySelector('.loading-text');
                if (loading) loading.style.display = 'flex';
                if (loadingText) loadingText.textContent = text;
            },

            hideLoading: () => {
                const loading = document.getElementById('loading');
                if (loading) loading.style.display = 'none';
            },

            showToast: (message, type = 'success') => {
                document.querySelectorAll('.toast').forEach(toast => toast.remove());

                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `<i class="fas fa-${UI.getToastIcon(type)}"></i> ${message}`;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.style.animation = 'slideOutRight 0.3s ease forwards';
                        setTimeout(() => toast.remove(), 300);
                    }
                }, CONFIG.TOAST_DURATION);

                toast.addEventListener('click', () => {
                    toast.style.animation = 'slideOutRight 0.3s ease forwards';
                    setTimeout(() => toast.remove(), 300);
                });
            },

            getToastIcon: (type) => {
                const icons = {
                    success: 'check-circle',
                    error: 'exclamation-triangle',
                    info: 'info-circle',
                    warning: 'exclamation-circle'
                };
                return icons[type] || 'info-circle';
            },

            closeModal: (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                    document.body.classList.remove('modal-open');
                    
                    if (modalId === 'formModal') {
                        FormManager.reset();
                        STATE.editingId = null;
                    }
                }
            }
        };

        const FormManager = {
            reset: () => {
                const form = document.getElementById('gameForm');
                if (form) form.reset();
                STATE.uploadedImages = [];
                FormManager.updateImagesPreview();
            },

            openAdd: () => {
                if (!STATE.isAuthenticated) {
                    UI.showToast('Accesso amministratore richiesto', 'error');
                    return;
                }
                
                STATE.editingId = null;
                document.getElementById('formTitle').textContent = 'Aggiungi Progetto';
                FormManager.reset();
                document.getElementById('formModal').style.display = 'block';
                document.body.style.overflow = 'hidden';
                document.body.classList.add('modal-open');
                
                setTimeout(() => {
                    document.getElementById('gameName')?.focus();
                }, 100);
            },

            editGame: (id) => {
                if (!STATE.isAuthenticated) return;
                
                const game = STATE.games.find(g => g.id === id);
                if (!game) return;

                STATE.editingId = id;
                document.getElementById('formTitle').textContent = 'Modifica Progetto';
                
                const fields = [
                    'gameName', 'gameCategory', 'gamePrice', 'gameModel', 'gameShell', 
                    'gameButtons', 'gameLabel', 'gameBattery', 'gameAudio', 'gameDisplay', 
                    'gameLed', 'gameBox', 'gameOther'
                ];
                const gameKeys = [
                    'name', 'category', 'price', 'model', 'shell', 'buttons', 
                    'label', 'battery', 'audio', 'display', 'led', 'box', 'other'
                ];
                
                fields.forEach((fieldId, i) => {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        element.value = game[gameKeys[i]] || '';
                    }
                });
                
                STATE.uploadedImages = (game.images || []).map((img, i) => ({
                    data: img,
                    name: `Immagine ${i + 1}`,
                    size: 0
                }));
                FormManager.updateImagesPreview();
                
                document.getElementById('formModal').style.display = 'block';
                document.body.style.overflow = 'hidden';
                document.body.classList.add('modal-open');
            },

            handleSubmit: async (e) => {
                e.preventDefault();
                
                if (!STATE.isAuthenticated || STATE.uploadedImages.length === 0) {
                    UI.showToast('Aggiungi almeno un\'immagine al progetto', 'error');
                    return;
                }

                const formData = FormManager.getFormData();
                if (!FormManager.validateFormData(formData)) {
                    return;
                }

                UI.showLoading('Salvataggio progetto...');

                try {
                    const gameData = {
                        id: STATE.editingId || Utils.generateId(),
                        ...formData,
                        images: STATE.uploadedImages.map(img => img.data),
                        createdAt: STATE.editingId ? 
                            (STATE.games.find(g => g.id === STATE.editingId)?.createdAt || new Date().toISOString()) : 
                            new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };

                    if (STATE.editingId) {
                        const index = STATE.games.findIndex(g => g.id === STATE.editingId);
                        if (index !== -1) {
                            STATE.games[index] = gameData;
                            UI.showToast('Progetto aggiornato con successo', 'success');
                        }
                    } else {
                        STATE.games.unshift(gameData);
                        UI.showToast('Nuovo progetto aggiunto con successo', 'success');
                    }

                    const saved = DataManager.saveLocal();
                    if (saved && STATE.cloudSyncEnabled && STATE.supabase && STATE.isOnline) {
                        await SupabaseManager.syncToCloud(false);
                    }
                    
                    UI.closeModal('formModal');
                    UI.renderGallery();
                    UI.updateStats();
                    
                } catch (error) {
                    console.error('Errore salvataggio:', error);
                    UI.showToast('Errore durante il salvataggio', 'error');
                } finally {
                    UI.hideLoading();
                }
            },

            getFormData: () => {
                return {
                    name: document.getElementById('gameName').value.trim(),
                    category: document.getElementById('gameCategory').value,
                    price: parseFloat(document.getElementById('gamePrice').value) || 0,
                    model: document.getElementById('gameModel').value.trim(),
                    shell: document.getElementById('gameShell').value.trim(),
                    buttons: document.getElementById('gameButtons').value.trim(),
                    label: document.getElementById('gameLabel').value.trim(),
                    battery: document.getElementById('gameBattery').value.trim(),
                    audio: document.getElementById('gameAudio').value.trim(),
                    display: document.getElementById('gameDisplay').value.trim(),
                    led: document.getElementById('gameLed').value.trim(),
                    box: document.getElementById('gameBox').value.trim(),
                    other: document.getElementById('gameOther').value.trim()
                };
            },

            validateFormData: (data) => {
                if (!data.name) {
                    UI.showToast('Il nome del progetto è obbligatorio', 'error');
                    document.getElementById('gameName')?.focus();
                    return false;
                }
                
                if (!data.category) {
                    UI.showToast('Seleziona una categoria', 'error');
                    document.getElementById('gameCategory')?.focus();
                    return false;
                }
                
                if (!data.model) {
                    UI.showToast('Il modello base è obbligatorio', 'error');
                    document.getElementById('gameModel')?.focus();
                    return false;
                }
                
                if (data.price < 0) {
                    UI.showToast('Il prezzo non può essere negativo', 'error');
                    document.getElementById('gamePrice')?.focus();
                    return false;
                }
                
                return true;
            },

            handleImagesSelect: (e) => {
                const files = Array.from(e.target.files);
                FormManager.processImages(files);
            },

            handleImagesDrop: (e) => {
                e.preventDefault();
                e.currentTarget.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files).filter(f => f.type.match('image.*'));
                FormManager.processImages(files);
            },

            processImages: async (files) => {
                if (STATE.uploadedImages.length + files.length > CONFIG.MAX_IMAGES) {
                    UI.showToast(`Massimo ${CONFIG.MAX_IMAGES} immagini consentite`, 'error');
                    return;
                }

                if (files.length === 0) return;

                UI.showLoading('Elaborazione immagini...');
                
                const results = [];
                for (const file of files) {
                    try {
                        if (!file.type.match('image.*')) {
                            continue;
                        }
                        
                        if (file.size > CONFIG.MAX_FILE_SIZE) {
                            UI.showToast(`File ${file.name} troppo grande (max 5MB)`, 'error');
                            continue;
                        }

                        let finalData;
                        // Comprimi sempre le immagini per risparmiare spazio
                        finalData = await Utils.compressImage(file);

                        results.push({
                            data: finalData,
                            name: file.name,
                            size: file.size
                        });
                    } catch (error) {
                        console.error('Errore elaborazione immagine:', file.name, error);
                    }
                }

                STATE.uploadedImages.push(...results);
                FormManager.updateImagesPreview();
                UI.hideLoading();
                
                if (results.length > 0) {
                    UI.showToast(`${results.length} immagini elaborate con successo`, 'success');
                }
            },

            updateImagesPreview: () => {
                const preview = document.getElementById('imagesPreview');
                const counter = document.getElementById('imageCount');
                const placeholder = document.getElementById('uploadPlaceholder');
                
                if (!preview || !counter || !placeholder) return;
                
                counter.textContent = `${STATE.uploadedImages.length} / ${CONFIG.MAX_IMAGES} immagini`;
                
                if (STATE.uploadedImages.length === 0) {
                    preview.innerHTML = '';
                    placeholder.style.display = 'block';
                    return;
                }

                placeholder.style.display = 'none';
                preview.innerHTML = STATE.uploadedImages.map((img, index) => `
                    <div class="image-preview-item" style="animation-delay: ${index * 0.1}s">
                        <img src="${img.data}" alt="${img.name}" class="image-preview-img" loading="lazy">
                        <button type="button" class="image-remove" 
                                onclick="removeImage(${index})" 
                                title="Rimuovi immagine">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('');
            },

            removeImage: (index) => {
                STATE.uploadedImages.splice(index, 1);
                FormManager.updateImagesPreview();
                UI.showToast('Immagine rimossa', 'info');
            }
        };

        const AuthManager = {
            showModal: () => {
                if (STATE.isAuthenticated) {
                    AuthManager.logout();
                } else {
                    document.getElementById('authModal').style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    document.body.classList.add('modal-open');
                    setTimeout(() => {
                        document.getElementById('authPassword')?.focus();
                    }, 100);
                }
            },

            closeModal: () => {
                document.getElementById('authModal').style.display = 'none';
                document.body.style.overflow = '';
                document.body.classList.remove('modal-open');
                document.getElementById('authPassword').value = '';
            },

            authenticate: () => {
                const password = document.getElementById('authPassword');
                if (password.value === CONFIG.ADMIN_PASSWORD) {
                    STATE.isAuthenticated = true;
                    UI.updateAuthUI();
                    AuthManager.closeModal();
                    UI.showToast('Accesso amministratore effettuato', 'success');
                    
                    if (STATE.cloudSyncEnabled && STATE.supabase && STATE.isOnline) {
                        SupabaseManager.syncFromCloud();
                    }
                } else {
                    UI.showToast('Password non corretta', 'error');
                    password.value = '';
                    password.focus();
                    
                    password.style.animation = 'shake 0.5s ease-in-out';
                    setTimeout(() => {
                        password.style.animation = '';
                    }, 500);
                }
            },

            logout: () => {
                STATE.isAuthenticated = false;
                STATE.editMode = false;
                STATE.compareMode = false;
                CompareManager.clear();
                UI.updateAuthUI();
                UI.renderGallery();
                UI.showToast('Disconnesso dalla modalità admin', 'info');
            }
        };

        const AdminManager = {
            toggleEditMode: () => {
                if (!STATE.isAuthenticated) {
                    UI.showToast('Accesso amministratore richiesto', 'error');
                    return;
                }
                
                STATE.editMode = !STATE.editMode;
                if (STATE.editMode) {
                    STATE.compareMode = false;
                    CompareManager.clear();
                }
                
                const btn = document.getElementById('editModeBtn');
                
                if (STATE.editMode) {
                    btn.innerHTML = '<i class="fas fa-times"></i> Esci';
                    btn.classList.add('edit-mode');
                    UI.showToast('Modalità modifica attiva', 'info');
                } else {
                    btn.innerHTML = '<i class="fas fa-edit"></i> Modifica';
                    btn.classList.remove('edit-mode');
                    UI.showToast('Modalità visualizzazione ripristinata', 'info');
                }
                
                UI.renderGallery();
            },

            deleteGame: (id) => {
                if (!STATE.isAuthenticated) return;
                
                const game = STATE.games.find(g => g.id === id);
                if (!game) return;
                
                if (confirm(`Sei sicuro di voler eliminare "${game.name}"?\n\nQuesta operazione non può essere annullata.`)) {
                    STATE.games = STATE.games.filter(g => g.id !== id);
                    STATE.selectedGames.delete(id); // Rimuovi anche dalla selezione confronto
                    DataManager.saveLocal();
                    
                    if (STATE.cloudSyncEnabled && STATE.supabase && STATE.isOnline) {
                        SupabaseManager.syncToCloud(false);
                    }
                    
                    UI.renderGallery();
                    UI.updateStats();
                    CompareManager.updateUI();
                    UI.showToast('Progetto eliminato', 'success');
                }
            },

            exportData: () => {
                if (!STATE.isAuthenticated) return;
                
                if (STATE.games.length === 0) {
                    UI.showToast('Nessun dato da esportare', 'error');
                    return;
                }
                
                const exportData = {
                    version: '2.3.0',
                    exportDate: new Date().toISOString(),
                    totalGames: STATE.games.length,
                    games: STATE.games
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `retroavia_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                UI.showToast(`${STATE.games.length} progetti esportati`, 'success');
            },

            importData: () => {
                if (!STATE.isAuthenticated) return;
                
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.style.display = 'none';
                
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    UI.showLoading('Importazione dati...');
                    
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            let importedGames = Array.isArray(importedData) ? 
                                importedData : 
                                importedData.games || [];
                            
                            if (importedGames.length === 0) {
                                throw new Error('Nessun progetto valido trovato nel file');
                            }

                            const replace = STATE.games.length > 0 ? 
                                confirm(`Vuoi sostituire i ${STATE.games.length} progetti esistenti con i ${importedGames.length} progetti importati?\n\nClicca "OK" per sostituire, "Annulla" per aggiungere.`) :
                                true;
                            
                            if (replace) {
                                STATE.games = importedGames;
                                STATE.selectedGames.clear();
                            } else {
                                importedGames.forEach(game => {
                                    if (!STATE.games.find(g => g.id === game.id)) {
                                        STATE.games.push(game);
                                    }
                                });
                            }
                            
                            DataManager.sortGames();
                            DataManager.saveLocal();
                            
                            if (STATE.cloudSyncEnabled && STATE.supabase && STATE.isOnline) {
                                await SupabaseManager.syncToCloud(false);
                            }
                            
                            UI.renderGallery();
                            UI.updateStats();
                            CompareManager.updateUI();
                            UI.showToast(`${importedGames.length} progetti importati`, 'success');
                            
                        } catch (error) {
                            console.error('Errore importazione:', error);
                            UI.showToast('File non valido o corrotto', 'error');
                        } finally {
                            UI.hideLoading();
                        }
                    };
                    reader.readAsText(file);
                };
                
                document.body.appendChild(input);
                input.click();
                document.body.removeChild(input);
            },

            clearAllData: () => {
                if (!STATE.isAuthenticated) return;
                
                if (STATE.games.length === 0) {
                    UI.showToast('Nessun dato da eliminare', 'info');
                    return;
                }

                const confirmation = prompt(
                    `⚠️ ATTENZIONE ⚠️\n\nStai per eliminare PERMANENTEMENTE tutti i ${STATE.games.length} progetti.\n\nQuesta operazione NON può essere annullata.\n\nPer confermare, scrivi esattamente: ELIMINA TUTTO`
                );
                
                if (confirmation === 'ELIMINA TUTTO') {
                    STATE.games = [];
                    STATE.selectedGames.clear();
                    DataManager.saveLocal();
                    
                    if (STATE.cloudSyncEnabled && STATE.supabase && STATE.isOnline) {
                        SupabaseManager.syncToCloud(false);
                    }
                    
                    UI.renderGallery();
                    UI.updateStats();
                    CompareManager.updateUI();
                    UI.showToast('Tutti i dati sono stati eliminati', 'success');
                } else if (confirmation !== null) {
                    UI.showToast('Testo di conferma non corretto', 'error');
                }
            }
        };

        // Sistema Zoom per le immagini
        const ZoomManager = {
            open: () => {
                if (STATE.currentGameImages.length === 0) return;
                
                const currentImage = STATE.currentGameImages[STATE.currentSlide];
                const zoomModal = document.getElementById('zoomModal');
                const zoomImage = document.getElementById('zoomImage');
                
                zoomImage.src = currentImage;
                zoomModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            },

            close: () => {
                const zoomModal = document.getElementById('zoomModal');
                zoomModal.style.display = 'none';
                document.body.style.overflow = 'hidden'; // Mantieni overflow hidden perché siamo ancora nel modal principale
            }
        };

        // Gestore unificato per modalità confronto
        const CompareToggleManager = {
            toggle: () => {
                STATE.compareMode = !STATE.compareMode;
                if (STATE.compareMode && STATE.editMode) {
                    STATE.editMode = false;
                }
                
                const userBtn = document.getElementById('userCompareModeBtn');
                
                if (STATE.compareMode) {
                    userBtn.innerHTML = '<i class="fas fa-times"></i> Esci dal Confronto';
                    userBtn.classList.add('compare-mode');
                    UI.showToast('Modalità confronto attiva - Seleziona i progetti da confrontare', 'info');
                } else {
                    userBtn.innerHTML = '<i class="fas fa-balance-scale"></i> Confronta Progetti';
                    userBtn.classList.remove('compare-mode');
                    CompareManager.clear();
                    UI.showToast('Modalità confronto disattivata', 'info');
                }
                
                UI.renderGallery();
            }
        };

        const EventHandlers = {
            setupAll: () => {
                EventHandlers.setupNavigation();
                EventHandlers.setupForm();
                EventHandlers.setupSearch();
                EventHandlers.setupAuth();
                EventHandlers.setupModals();
                EventHandlers.setupKeyboard();
            },

            setupNavigation: () => {
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        UI.switchCategory(tab.dataset.category, tab);
                    });
                });

                const sortDropdown = document.getElementById('sortDropdown');
                if (sortDropdown) {
                    sortDropdown.addEventListener('change', (e) => {
                        STATE.sortBy = e.target.value;
                        UI.renderGallery();
                    });
                }
            },

            setupForm: () => {
                const gameForm = document.getElementById('gameForm');
                if (gameForm) {
                    gameForm.addEventListener('submit', FormManager.handleSubmit);
                }

                const gameImages = document.getElementById('gameImages');
                if (gameImages) {
                    gameImages.addEventListener('change', FormManager.handleImagesSelect);
                }
                
                const uploadContainer = document.getElementById('imagesUploadContainer');
                if (uploadContainer) {
                    uploadContainer.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.currentTarget.classList.add('dragover');
                    });
                    
                    uploadContainer.addEventListener('dragleave', (e) => {
                        e.currentTarget.classList.remove('dragover');
                    });
                    
                    uploadContainer.addEventListener('drop', FormManager.handleImagesDrop);
                }
            },

            setupSearch: () => {
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    const debouncedSearch = Utils.debounce((query) => {
                        STATE.searchQuery = query.toLowerCase().trim();
                        UI.renderGallery();
                    }, CONFIG.SEARCH_DEBOUNCE);
                    
                    searchInput.addEventListener('input', (e) => {
                        debouncedSearch(e.target.value);
                    });
                }
            },

            setupAuth: () => {
                const authPassword = document.getElementById('authPassword');
                if (authPassword) {
                    authPassword.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            AuthManager.authenticate();
                        }
                    });
                }
            },

            setupModals: () => {
                window.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal') || 
                        e.target.classList.contains('form-modal') || 
                        e.target.classList.contains('auth-modal') ||
                        e.target.classList.contains('compare-modal')) {
                        UI.closeModal(e.target.id);
                    }
                });
            },

            setupKeyboard: () => {
                document.addEventListener('keydown', (e) => {
                    switch(e.key) {
                        case 'Escape':
                            if (document.getElementById('zoomModal').style.display === 'block') {
                                ZoomManager.close();
                            } else {
                                UI.closeModal('detailModal');
                                UI.closeModal('formModal');
                                UI.closeModal('compareModal');
                                AuthManager.closeModal();
                            }
                            break;
                        case 'ArrowLeft':
                            if (document.getElementById('detailModal').style.display === 'block') {
                                UI.changeSlide(-1);
                                e.preventDefault();
                            }
                            break;
                        case 'ArrowRight':
                            if (document.getElementById('detailModal').style.display === 'block') {
                                UI.changeSlide(1);
                                e.preventDefault();
                            }
                            break;
                    }
                });
            }
        };

        const App = {
            initialize: () => {
                UI.updateSyncStatus('syncing', 'Inizializzazione...');
                
                NetworkManager.init();
                
                let attempts = 0;
                const maxAttempts = 5;
                
                const tryInit = () => {
                    attempts++;
                    if (SupabaseManager.initialize()) {
                        App.start();
                        return;
                    }
                    
                    if (attempts < maxAttempts) {
                        setTimeout(tryInit, 200);
                    } else {
                        STATE.cloudSyncEnabled = false;
                        App.start();
                    }
                };
                
                setTimeout(tryInit, 100);
            },

            start: () => {
                DataManager.loadLocal();
                EventHandlers.setupAll();
                UI.updateStats();
                UI.updateAuthUI();
                
                if (STATE.cloudSyncEnabled && STATE.supabase && STATE.isOnline) {
                    SupabaseManager.syncFromCloud();
                } else {
                    UI.updateSyncStatus('local', STATE.isOnline ? 'Modalità offline' : 'Offline');
                }

                setTimeout(() => {
                    UI.hideLoading();
                }, 500);
            }
        };

        // Definisco le funzioni globali IMMEDIATAMENTE e correttamente
        window.showAuthModal = () => AuthManager.showModal();
        window.closeAuthModal = () => AuthManager.closeModal();
        window.authenticate = () => AuthManager.authenticate();
        window.openAddModal = () => FormManager.openAdd();
        window.toggleEditMode = () => AdminManager.toggleEditMode();
        window.toggleCompareMode = () => CompareToggleManager.toggle(); // Usa il gestore unificato
        window.forceSyncData = () => {
            if (!STATE.isAuthenticated) {
                UI.showToast('Accesso amministratore richiesto', 'error');
                return;
            }
            if (!STATE.isOnline) {
                UI.showToast('Connessione offline', 'error');
                return;
            }
            SupabaseManager.syncToCloud(true);
        };
        window.exportData = () => AdminManager.exportData();
        window.importData = () => AdminManager.importData();
        window.clearAllData = () => AdminManager.clearAllData();
        window.closeModal = (modalId) => UI.closeModal(modalId);
        window.changeSlide = (direction) => UI.changeSlide(direction);
        window.goToSlide = (index) => UI.goToSlide(index);
        window.removeImage = (index) => FormManager.removeImage(index);

        // Funzioni per il sistema di confronto
        window.toggleCompare = (gameId) => {
            const success = CompareManager.toggleGame(gameId);
            if (success) {
                setTimeout(() => CompareManager.updateUI(), 50);
            }
        };
        window.openCompareModal = () => CompareManager.openModal();
        window.clearCompareSelection = () => CompareManager.clear();

        // Funzioni per zoom
        window.openZoomModal = () => ZoomManager.open();
        window.closeZoomModal = () => ZoomManager.close();

        // Gestione click su card (normale vs confronto)
        window.handleCardClick = (gameId, event) => {
            if (STATE.compareMode) {
                // In modalità confronto, gestisci come toggle
                window.toggleCompare(gameId);
            } else if (!STATE.editMode) {
                // In modalità normale, mostra i dettagli
                UI.showDetails(gameId);
            }
        };

        window.showDetails = (id) => UI.showDetails(id);
        window.editGame = (id) => {
            if (!STATE.isAuthenticated) {
                UI.showToast('Accesso amministratore richiesto', 'error');
                return;
            }
            FormManager.editGame(id);
        };
        window.deleteGame = (id) => {
            if (!STATE.isAuthenticated) {
                UI.showToast('Accesso amministratore richiesto', 'error');
                return;
            }
            AdminManager.deleteGame(id);
        };

        // Inizializzazione app
        document.addEventListener('DOMContentLoaded', App.initialize);
    </script>
</body>
</html>
