<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetroAvia - Gallery Game Boy</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            /* Palette colori più professionale e minimal */
            --bg-primary: #0f0f0f;
            --bg-secondary: #161616;
            --bg-tertiary: #1e1e1e;
            --bg-card: #1a1a1a;
            --bg-card-hover: #242424;
            --bg-glass: rgba(255, 255, 255, 0.03);
            --bg-glass-strong: rgba(255, 255, 255, 0.06);
            --bg-overlay: rgba(0, 0, 0, 0.85);
            
            /* Accenti più sobri e professionali */
            --accent-primary: #3b82f6;
            --accent-secondary: #10b981;
            --accent-tertiary: #f59e0b;
            --accent-error: #ef4444;
            --accent-warning: #f97316;
            --accent-info: #06b6d4;
            
            /* Testi più leggibili */
            --text-primary: #f8fafc;
            --text-secondary: #e2e8f0;
            --text-muted: #94a3b8;
            --text-dim: #64748b;
            
            /* Bordi più sottili */
            --border-primary: #334155;
            --border-secondary: rgba(255, 255, 255, 0.08);
            --border-accent: rgba(59, 130, 246, 0.3);
            
            /* Ombre più professionali */
            --shadow-primary: rgba(0, 0, 0, 0.25);
            --shadow-secondary: rgba(0, 0, 0, 0.15);
            --shadow-accent: rgba(59, 130, 246, 0.25);
            
            /* Gradienti più eleganti */
            --gradient-primary: linear-gradient(135deg, var(--accent-primary), #2563eb);
            --gradient-secondary: linear-gradient(135deg, var(--accent-secondary), #059669);
            --gradient-glass: linear-gradient(135deg, var(--bg-glass), var(--bg-glass-strong));
            --gradient-card: linear-gradient(135deg, var(--bg-card), rgba(26, 26, 26, 0.95));
            
            /* Transizioni più fluide */
            --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Border radius più moderni */
            --border-radius-sm: 6px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 16px;
            --border-radius-2xl: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Miglioramenti aggiuntivi per look professionale */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
            font-feature-settings: 'liga', 'kern';
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Background più sottile e professionale */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 25% 25%, rgba(71, 85, 105, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(100, 116, 139, 0.02) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* Header con gradiente più elegante e professionale */
        .header h1 {
            font-family: 'Inter', sans-serif;
            font-size: clamp(2.5rem, 6vw, 4rem);
            font-weight: 800;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #475569, #64748b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.04em;
            position: relative;
            z-index: 2;
        }

        .header .subtitle {
            font-size: clamp(1rem, 2.5vw, 1.25rem);
            color: var(--text-secondary);
            font-weight: 400;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        /* Perfezionamenti per un look più pulito */
        .search-filters-container {
            background: var(--gradient-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-secondary);
            padding: 2rem;
        }

        .nav-container {
            padding: 1.5rem 2rem;
            background: var(--gradient-glass);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-secondary);
        }

        .stats-bar {
            background: var(--gradient-glass);
            backdrop-filter: blur(20px);
            padding: 2rem;
            border-bottom: 1px solid var(--border-secondary);
        }

        /* Card hover effects più subtili e professionali */
        .game-card:hover {
            transform: translateY(-6px) scale(1.01);
            box-shadow: 0 20px 40px var(--shadow-primary);
            border-color: rgba(71, 85, 105, 0.4);
        }

        /* Buttons con stile più raffinato */
        .admin-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.25);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(71, 85, 105, 0.3);
        }

        /* Modal con stile più pulito */
        .modal-close:hover {
            background: var(--accent-error);
            color: white;
            transform: scale(1.05);
        }

        /* Rimuovi completamente tutti i keyframes di animazioni continue */

        /* Scrollbar più elegante */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { 
            background: var(--bg-secondary); 
            border-radius: var(--border-radius-sm);
        }
        ::-webkit-scrollbar-thumb { 
            background: var(--gradient-primary);
            border-radius: var(--border-radius-sm);
            transition: var(--transition-normal);
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--gradient-secondary);
        }

        /* Header più professionale con sfondo migliorato */
        .header {
            background: 
                linear-gradient(135deg, 
                    rgba(59, 130, 246, 0.15) 0%, 
                    rgba(16, 185, 129, 0.12) 50%, 
                    rgba(245, 158, 11, 0.08) 100%),
                linear-gradient(to bottom, 
                    var(--bg-secondary) 0%, 
                    var(--bg-primary) 100%);
            backdrop-filter: blur(20px) saturate(1.3);
            -webkit-backdrop-filter: blur(20px) saturate(1.3);
            border-bottom: 1px solid var(--border-secondary);
            padding: 4rem 0 3rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        /* Elementi decorativi per l'header */
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 30% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 25%),
                radial-gradient(circle at 70% 80%, rgba(16, 185, 129, 0.08) 0%, transparent 25%);
            animation: headerFloat 20s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes headerFloat {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(20px, -15px) rotate(1deg); }
            66% { transform: translate(-15px, 10px) rotate(-0.5deg); }
        }

        .header h1 {
            font-family: 'Inter', sans-serif;
            font-size: clamp(2.5rem, 6vw, 4rem);
            font-weight: 800;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.04em;
            position: relative;
            z-index: 2;
            animation: titleGlow 3s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            0% { filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.3)); }
            100% { filter: drop-shadow(0 0 20px rgba(16, 185, 129, 0.3)); }
        }

        .header .subtitle {
            font-size: clamp(1rem, 2.5vw, 1.25rem);
            color: var(--text-secondary);
            font-weight: 400;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
            animation: subtitleSlide 1s ease-out 0.3s both;
        }

        @keyframes subtitleSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Controlli admin più puliti - FIXED Z-INDEX */
        .admin-header-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-overlay);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--border-radius-xl);
            padding: 12px 16px;
            z-index: 1200; /* Ridotto per non interferire con modal */
            border: 1px solid var(--border-secondary);
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 32px var(--shadow-primary);
            transition: var(--transition-normal);
        }

        .admin-header-controls:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px var(--shadow-primary);
        }

        .admin-header-controls .auth-status {
            padding: 8px 14px;
            border-radius: var(--border-radius-lg);
            font-size: 0.875rem;
            font-weight: 500;
            background: var(--bg-glass);
            border: 1px solid var(--border-secondary);
            transition: var(--transition-normal);
        }

        .admin-header-controls .auth-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .admin-header-controls .auth-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px var(--shadow-accent);
        }

        .admin-header-controls .auth-btn.logout {
            background: var(--gradient-secondary);
        }

        /* Sync status più discreto */
        .sync-status {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--bg-overlay);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-lg);
            padding: 8px 12px;
            font-size: 0.75rem;
            font-weight: 500;
            z-index: 1100;
            border: 1px solid var(--border-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            transition: var(--transition-normal);
        }

        .sync-status.syncing { color: var(--accent-info); }
        .sync-status.synced { color: var(--accent-secondary); }
        .sync-status.error { color: var(--accent-error); }

        /* Search e filtri più puliti */
        .search-filters-container {
            background: var(--gradient-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-secondary);
            padding: 2rem;
        }

        .search-filters-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .search-section {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex: 1;
        }

        .filters-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .gallery-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            animation: titlePulse 2s ease-in-out infinite;
        }

        @keyframes titlePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .search-box {
            position: relative;
            max-width: 320px;
            min-width: 240px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 1px solid var(--border-secondary);
            border-radius: var(--border-radius-xl);
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: var(--transition-normal);
            font-family: inherit;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: var(--bg-glass-strong);
            transform: scale(1.02);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 0.875rem;
            transition: var(--transition-normal);
        }

        .search-input:focus + .search-icon {
            color: var(--accent-primary);
            animation: searchPulse 1s ease-in-out infinite;
        }

        @keyframes searchPulse {
            0%, 100% { transform: translateY(-50%) scale(1); }
            50% { transform: translateY(-50%) scale(1.1); }
        }

        .sort-dropdown {
            padding: 12px 16px;
            border: 1px solid var(--border-secondary);
            border-radius: var(--border-radius-lg);
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition-normal);
            min-width: 140px;
        }

        .sort-dropdown:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: scale(1.02);
        }

        .filter-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
        }

        /* Statistiche più eleganti con emoji */
        .stats-bar {
            background: var(--gradient-glass);
            backdrop-filter: blur(20px);
            padding: 2rem;
            border-bottom: 1px solid var(--border-secondary);
        }

        .stats-container {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
            max-width: 800px;
            margin: 0 auto;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 1.5rem 1rem;
            border-radius: var(--border-radius-lg);
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-secondary);
            transition: var(--transition-normal);
            min-width: 120px;
            animation: statFloat 3s ease-in-out infinite;
            animation-delay: calc(var(--i) * 0.2s);
        }

        @keyframes statFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .stat-item:hover {
            transform: translateY(-8px);
            background: var(--bg-glass-strong);
            box-shadow: 0 8px 25px var(--shadow-secondary);
            animation-play-state: paused;
        }

        .stat-number {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.75rem;
            font-weight: 600;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        /* Navigazione più minimal */
        .nav-container {
            padding: 1.5rem 2rem;
            background: var(--gradient-glass);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-secondary);
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            max-width: 600px;
            margin: 0 auto;
        }

        .nav-tab {
            background: var(--bg-glass);
            color: var(--text-secondary);
            border: 1px solid var(--border-secondary);
            padding: 12px 20px;
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: tabSlide 0.5s ease-out;
            animation-delay: calc(var(--i) * 0.1s);
            animation-fill-mode: both;
        }

        @keyframes tabSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .nav-tab:hover {
            color: var(--text-primary);
            border-color: var(--accent-primary);
            background: var(--bg-glass-strong);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--accent-primary);
            box-shadow: 0 4px 12px var(--shadow-accent);
            transform: translateY(-2px);
        }

        /* Controlli admin più organizzati */
        .admin-controls {
            padding: 2rem;
            background: var(--gradient-glass);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-secondary);
            display: none;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .admin-controls.show {
            display: flex;
        }

        .admin-btn {
            background: var(--gradient-secondary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .admin-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .admin-btn:hover::before {
            left: 100%;
        }

        .admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .admin-btn.edit-mode {
            background: linear-gradient(135deg, var(--accent-tertiary), #d97706);
        }

        .admin-btn.export {
            background: linear-gradient(135deg, var(--accent-info), #0891b2);
        }

        .admin-btn.import {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .admin-btn.clear {
            background: linear-gradient(135deg, var(--accent-error), #dc2626);
        }

        .admin-btn.sync {
            background: linear-gradient(135deg, var(--accent-primary), #2563eb);
        }

        /* Galleria più elegante */
        .gallery-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
        }

        .game-card {
            background: var(--gradient-card);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-secondary);
            border-radius: var(--border-radius-xl);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition-slow);
            opacity: 0;
            animation: cardFadeIn 0.6s ease forwards;
            animation-delay: calc(var(--i) * 0.05s);
        }

        @keyframes cardFadeIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .game-card:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow: 0 25px 50px var(--shadow-primary);
            border-color: var(--accent-primary);
        }

        .game-image-container {
            position: relative;
            width: 100%;
            height: 280px;
            overflow: hidden;
            background: var(--bg-tertiary);
        }

        .game-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: var(--transition-slow);
        }

        .game-card:hover .game-image {
            transform: scale(1.08);
        }

        .game-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: var(--text-dim);
            background: var(--bg-tertiary);
            animation: placeholderPulse 2s ease-in-out infinite;
        }

        @keyframes placeholderPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.8; }
        }

        .image-indicator {
            position: absolute;
            top: 12px;
            left: 12px;
            background: var(--bg-overlay);
            backdrop-filter: blur(10px);
            color: var(--accent-secondary);
            padding: 4px 8px;
            border-radius: var(--border-radius-md);
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid var(--border-secondary);
            animation: indicatorBounce 2s ease-in-out infinite;
        }

        @keyframes indicatorBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .edit-controls {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 10;
            display: flex;
            gap: 8px;
        }

        .edit-btn {
            background: var(--bg-overlay);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-secondary);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-normal);
            font-size: 0.875rem;
        }

        .edit-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            transform: scale(1.1) rotate(5deg);
        }

        .edit-btn.delete:hover {
            background: var(--accent-error);
            border-color: var(--accent-error);
        }

        .game-info {
            padding: 1.5rem;
        }

        .game-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            line-height: 1.3;
        }

        .game-model {
            color: var(--text-muted);
            margin-bottom: 1rem;
            font-size: 0.875rem;
            font-weight: 400;
        }

        .game-price {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'JetBrains Mono', monospace;
        }

        .game-date {
            position: absolute;
            bottom: 12px;
            right: 12px;
            background: var(--bg-overlay);
            backdrop-filter: blur(10px);
            color: var(--text-muted);
            padding: 4px 8px;
            border-radius: var(--border-radius-md);
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid var(--border-secondary);
        }

        /* Modal più elegante - FIXED Z-INDEX */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-overlay);
            backdrop-filter: blur(20px);
            z-index: 2000; /* Aumentato per essere sopra tutto */
            overflow-y: auto;
            padding: 2rem;
        }

        .modal-content {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--gradient-card);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-2xl);
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border-secondary);
            animation: modalSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 25px 50px var(--shadow-primary);
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.25rem;
            color: var(--text-primary);
            cursor: pointer;
            z-index: 2001; /* Molto alto per essere sicuri */
            width: 40px;
            height: 40px;
            background: var(--bg-overlay);
            backdrop-filter: blur(15px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-normal);
            border: 1px solid var(--border-secondary);
        }

        .modal-close:hover {
            background: var(--accent-error);
            color: white;
            transform: scale(1.1) rotate(90deg);
        }

        .modal-gallery {
            position: relative;
            width: 100%;
            height: 500px;
            overflow: hidden;
            background: var(--bg-tertiary);
        }

        .gallery-container-modal {
            display: flex;
            width: 100%;
            height: 100%;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .gallery-slide {
            min-width: 100%;
            height: 100%;
            position: relative;
        }

        .modal-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: var(--transition-normal);
        }

        .modal-image:hover {
            transform: scale(1.02);
        }

        .modal-image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: var(--text-dim);
            background: var(--bg-tertiary);
        }

        .gallery-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-overlay);
            backdrop-filter: blur(15px);
            color: white;
            border: 1px solid var(--border-secondary);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.125rem;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1900; /* Sotto il modal-close ma sopra il resto */
        }

        .gallery-nav:hover {
            background: var(--accent-primary);
            transform: translateY(-50%) scale(1.1);
        }

        .gallery-nav.prev { left: 20px; }
        .gallery-nav.next { right: 20px; }

        .gallery-indicators {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 1900;
        }

        .gallery-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            cursor: pointer;
            transition: var(--transition-normal);
        }

        .gallery-dot.active,
        .gallery-dot:hover {
            background: var(--accent-primary);
            transform: scale(1.3);
        }

        .gallery-counter {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--bg-overlay);
            backdrop-filter: blur(15px);
            color: white;
            padding: 8px 12px;
            border-radius: var(--border-radius-lg);
            font-size: 0.875rem;
            font-weight: 600;
            border: 1px solid var(--border-secondary);
            z-index: 1900;
        }

        .modal-info {
            padding: 2rem;
        }

        .modal-title {
            font-size: clamp(1.75rem, 4vw, 2.5rem);
            font-weight: 700;
            margin-bottom: 1.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
            animation: titleShimmer 2s ease-in-out infinite;
        }

        @keyframes titleShimmer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .spec-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .spec-item {
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            padding: 1.25rem;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-secondary);
            transition: var(--transition-normal);
            animation: specSlide 0.5s ease-out;
            animation-fill-mode: both;
        }

        @keyframes specSlide {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .spec-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px var(--shadow-secondary);
            border-color: var(--accent-primary);
        }

        .spec-label {
            font-weight: 600;
            color: var(--accent-secondary);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .spec-value {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.4;
        }

        .modal-price {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-secondary);
            font-family: 'JetBrains Mono', monospace;
            animation: priceGlow 2s ease-in-out infinite alternate;
        }

        @keyframes priceGlow {
            0% { filter: drop-shadow(0 0 5px rgba(59, 130, 246, 0.3)); }
            100% { filter: drop-shadow(0 0 15px rgba(16, 185, 129, 0.4)); }
        }

        /* Form più puliti */
        .form-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-overlay);
            backdrop-filter: blur(20px);
            z-index: 2000;
            overflow-y: auto;
            padding: 2rem;
        }

        .form-content {
            max-width: 800px;
            margin: 0 auto;
            background: var(--gradient-card);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-2xl);
            padding: 2rem;
            position: relative;
            border: 1px solid var(--border-secondary);
            animation: modalSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 25px 50px var(--shadow-primary);
        }

        .form-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 2rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--accent-secondary);
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-secondary);
            border-radius: var(--border-radius-lg);
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: var(--transition-normal);
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: var(--bg-glass-strong);
            transform: scale(1.02);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-muted);
        }

        /* Upload area migliorata */
        .images-upload-container {
            border: 2px dashed var(--border-secondary);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            text-align: center;
            background: var(--bg-glass);
            transition: var(--transition-normal);
            position: relative;
        }

        .images-upload-container:hover {
            border-color: var(--accent-primary);
            background: var(--bg-glass-strong);
            transform: scale(1.02);
        }

        .images-upload-container.dragover {
            border-color: var(--accent-secondary);
            background: rgba(16, 185, 129, 0.1);
            transform: scale(1.05);
        }

        .images-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 2;
        }

        .upload-placeholder {
            pointer-events: none;
        }

        .upload-placeholder i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--accent-primary);
            opacity: 0.7;
        }

        .upload-placeholder div {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .upload-placeholder small {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .images-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .image-preview-item {
            position: relative;
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            aspect-ratio: 1;
            border: 2px solid var(--border-secondary);
            transition: var(--transition-normal);
            animation: imageSlideIn 0.3s ease-out;
        }

        @keyframes imageSlideIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .image-preview-item:hover {
            border-color: var(--accent-primary);
            transform: scale(1.05) rotate(2deg);
        }

        .image-preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-remove {
            position: absolute;
            top: 6px;
            right: 6px;
            background: var(--accent-error);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-normal);
        }

        .image-remove:hover {
            background: #ff6666;
            transform: scale(1.3) rotate(90deg);
        }

        .image-count {
            color: var(--accent-secondary);
            font-size: 0.875rem;
            margin-top: 0.75rem;
            font-weight: 500;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-secondary);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: var(--transition-normal);
            font-family: inherit;
            min-width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--shadow-accent);
        }

        .btn-secondary {
            background: var(--bg-glass);
            color: var(--text-secondary);
            border: 1px solid var(--border-secondary);
        }

        .btn-secondary:hover {
            background: var(--bg-glass-strong);
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        /* Stati vuoti */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
            grid-column: 1 / -1;
            animation: emptyStatePulse 2s ease-in-out infinite;
        }

        @keyframes emptyStatePulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            opacity: 0.4;
            color: var(--accent-primary);
            animation: emptyStateFloat 3s ease-in-out infinite;
        }

        @keyframes emptyStateFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .empty-state p {
            font-size: 1rem;
            line-height: 1.6;
        }

        /* Loading */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-overlay);
            backdrop-filter: blur(20px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            flex-direction: column;
            gap: 1rem;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-secondary);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 1rem;
        }

        /* Auth modal */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-overlay);
            backdrop-filter: blur(20px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .auth-content {
            background: var(--gradient-card);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-xl);
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            text-align: center;
            border: 1px solid var(--border-secondary);
            animation: modalSlideUp 0.3s ease;
            box-shadow: 0 25px 50px var(--shadow-primary);
        }

        .auth-content h3 {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .auth-content p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
        }

        .auth-content input {
            width: 100%;
            padding: 12px 16px;
            margin: 1rem 0;
            border: 1px solid var(--border-secondary);
            border-radius: var(--border-radius-lg);
            background: var(--bg-glass);
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: var(--transition-normal);
        }

        .auth-content input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: scale(1.02);
        }

        .auth-content .btn {
            margin: 0.5rem;
            flex: 1;
        }

        /* Toast migliorati */
        .toast {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 16px 20px;
            border-radius: var(--border-radius-lg);
            font-weight: 500;
            font-size: 0.875rem;
            z-index: 3000;
            animation: slideInRight 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 350px;
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-secondary);
            box-shadow: 0 8px 25px var(--shadow-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.success {
            background: linear-gradient(135deg, var(--accent-secondary), #059669);
            color: white;
        }

        .toast.error {
            background: linear-gradient(135deg, var(--accent-error), #dc2626);
            color: white;
        }

        .toast.info {
            background: linear-gradient(135deg, var(--accent-info), #0891b2);
            color: white;
        }

        @keyframes slideInRight {
            from { 
                transform: translateX(100%); 
                opacity: 0; 
            }
            to { 
                transform: translateX(0); 
                opacity: 1; 
            }
        }

        @keyframes slideOutRight {
            to { transform: translateX(100%); opacity: 0; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Responsive design migliorato - FIXED MOBILE Z-INDEX ISSUE */
        @media (max-width: 768px) {
            .header {
                padding: 2rem 0;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }

            /* FIXED: Admin controls positioning on mobile */
            .admin-header-controls {
                top: 10px;
                right: 10px;
                padding: 8px 12px;
                flex-direction: column;
                gap: 8px;
                z-index: 900; /* Ridotto per mobile */
            }

            .admin-header-controls .auth-status {
                padding: 6px 10px;
                font-size: 0.75rem;
            }

            .admin-header-controls .auth-btn {
                padding: 6px 12px;
                font-size: 0.75rem;
            }

            /* FIXED: Modal close button on mobile */
            .modal {
                z-index: 1500; /* Più alto degli admin controls su mobile */
            }

            .modal-close {
                top: 15px;
                right: 15px;
                width: 44px; /* Più grande per touch */
                height: 44px;
                z-index: 1501; /* Sopra il modal */
                font-size: 1.5rem;
            }

            .search-filters-wrapper {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .search-section {
                flex-direction: column;
                gap: 1rem;
            }

            .filters-section {
                justify-content: center;
            }

            .gallery {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .modal-content,
            .form-content {
                margin: 1rem;
                padding: 1.5rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .nav-tabs {
                flex-direction: column;
                gap: 8px;
            }
            
            .admin-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .admin-btn {
                width: 100%;
                max-width: 250px;
            }
            
            .stats-container {
                gap: 1rem;
            }
            
            .gallery-nav {
                width: 44px; /* Più grande per touch */
                height: 44px;
                font-size: 1rem;
            }
            
            .images-preview {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
                gap: 0.75rem;
            }
            
            .form-actions {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .btn {
                width: 100%;
            }

            .filter-label {
                display: none;
            }

            .toast {
                top: 20px;
                right: 20px;
                left: 20px;
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            .gallery-container {
                padding: 2rem 1rem;
            }

            .search-filters-container {
                padding: 1rem;
            }

            .modal,
            .form-modal,
            .auth-modal {
                padding: 1rem;
            }
            
            .modal-content,
            .form-content,
            .auth-content {
                padding: 1rem;
            }
            
            .modal-gallery {
                height: 300px;
            }
            
            .gallery-nav.prev { left: 10px; }
            .gallery-nav.next { right: 10px; }

            /* Admin controls even smaller on very small screens */
            .admin-header-controls {
                top: 5px;
                right: 5px;
                padding: 6px 8px;
                z-index: 800; /* Ancora più basso */
            }

            .modal-close {
                top: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
            }
        }

        /* Animazioni di caricamento più fluide */
        .fade-in {
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .slide-up {
            transform: translateY(20px);
            opacity: 0;
            animation: slideUp 0.5s ease forwards;
        }

        @keyframes slideUp {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="sync-status" id="syncStatus" style="display: none;">
        <i class="fas fa-cloud" id="syncIcon"></i>
        <span id="syncText">Inizializzazione...</span>
    </div>

    <div class="admin-header-controls" id="adminHeaderControls">
        <div class="auth-status" id="authStatus">
            <i class="fas fa-lock" id="authIcon"></i>
            <span id="authText">Modalità Visitatore</span>
        </div>
        <button class="auth-btn" id="authButton" onclick="showAuthModal()">
            <i class="fas fa-sign-in-alt"></i> Accedi
        </button>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Caricamento...</div>
    </div>

    <div class="auth-modal" id="authModal">
        <div class="auth-content">
            <h3>🔐 Accesso Admin</h3>
            <p>Inserisci la password per accedere alle funzionalità di amministrazione</p>
            <input type="password" id="authPassword" placeholder="Password admin" autocomplete="current-password">
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="closeAuthModal()">
                    <i class="fas fa-times"></i> Annulla
                </button>
                <button class="btn btn-primary" onclick="authenticate()">
                    <i class="fas fa-sign-in-alt"></i> Accedi
                </button>
            </div>
        </div>
    </div>

    <header class="header">
        <h1>🎮 RetroAvia</h1>
        <p class="subtitle">✨ Galleria progetti Game Boy personalizzati · Creazioni uniche e modifiche professionali 🚀</p>
    </header>

    <div class="stats-bar">
        <div class="stats-container">
            <div class="stat-item" style="--i: 0">
                <div class="stat-number" id="totalGames">0</div>
                <div class="stat-label">🎯 Totale Progetti</div>
            </div>
            <div class="stat-item" style="--i: 1">
                <div class="stat-number" id="colorGames">0</div>
                <div class="stat-label">🌈 Game Boy Color</div>
            </div>
            <div class="stat-item" style="--i: 2">
                <div class="stat-number" id="advanceGames">0</div>
                <div class="stat-label">📱 Game Boy Advance</div>
            </div>
            <div class="stat-item" style="--i: 3">
                <div class="stat-number" id="spGames">0</div>
                <div class="stat-label">💎 Game Boy Advance SP</div>
            </div>
        </div>
    </div>

    <div class="nav-container">
        <nav class="nav-tabs">
            <button class="nav-tab active" data-category="all" style="--i: 0">
                <i class="fas fa-gamepad"></i> 🌟 Tutti
            </button>
            <button class="nav-tab" data-category="color" style="--i: 1">
                <i class="fas fa-palette"></i> 🌈 Color
            </button>
            <button class="nav-tab" data-category="advance" style="--i: 2">
                <i class="fas fa-mobile-alt"></i> 📱 Advance
            </button>
            <button class="nav-tab" data-category="sp" style="--i: 3">
                <i class="fas fa-laptop"></i> 💎 Advance SP
            </button>
        </nav>
    </div>

    <div class="admin-controls" id="adminControls">
        <button class="admin-btn" onclick="openAddModal()">
            <i class="fas fa-plus"></i> ➕ Aggiungi
        </button>
        <button class="admin-btn" id="editModeBtn" onclick="toggleEditMode()">
            <i class="fas fa-edit"></i> ✏️ Modifica
        </button>
        <button class="admin-btn sync" onclick="forceSyncData()">
            <i class="fas fa-sync-alt"></i> 🔄 Sincronizza
        </button>
        <button class="admin-btn export" onclick="exportData()">
            <i class="fas fa-download"></i> 📥 Esporta
        </button>
        <button class="admin-btn import" onclick="importData()">
            <i class="fas fa-upload"></i> 📤 Importa
        </button>
        <button class="admin-btn clear" onclick="clearAllData()">
            <i class="fas fa-trash-alt"></i> 🗑️ Cancella
        </button>
    </div>

    <div class="search-filters-container">
        <div class="search-filters-wrapper">
            <div class="search-section">
                <h2 class="gallery-title" id="galleryTitle">🌟 Tutti i Progetti</h2>
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="🔍 Cerca progetti...">
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>
            <div class="filters-section">
                <span class="filter-label">Ordina:</span>
                <select class="sort-dropdown" id="sortDropdown">
                    <option value="date-desc">📅 Più recenti</option>
                    <option value="date-asc">📅 Più vecchi</option>
                    <option value="name-asc">🔤 Nome A-Z</option>
                    <option value="name-desc">🔤 Nome Z-A</option>
                    <option value="price-desc">💰 Prezzo alto</option>
                    <option value="price-asc">💰 Prezzo basso</option>
                </select>
            </div>
        </div>
    </div>

    <div class="gallery-container">
        <div class="gallery" id="gallery">
            <div class="empty-state">
                <i class="fas fa-gamepad"></i>
                <h3>🎮 Nessun progetto disponibile</h3>
                <p>✨ I progetti RetroAvia appariranno qui una volta aggiunti</p>
            </div>
        </div>
    </div>

    <!-- Modal dettaglio progetto -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('detailModal')">
                <i class="fas fa-times"></i>
            </span>
            <div class="modal-gallery" id="modalGallery">
                <div class="gallery-container-modal" id="galleryContainerModal">
                    <div class="gallery-slide">
                        <div class="modal-image-placeholder">
                            <i class="fas fa-gamepad"></i>
                        </div>
                    </div>
                </div>
                <button class="gallery-nav prev" id="prevBtn" onclick="changeSlide(-1)">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="gallery-nav next" id="nextBtn" onclick="changeSlide(1)">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <div class="gallery-counter" id="galleryCounter">1 / 1</div>
                <div class="gallery-indicators" id="galleryIndicators"></div>
            </div>
            <div class="modal-info">
                <h2 class="modal-title" id="modalTitle">🎮 Progetto</h2>
                <div class="spec-grid" id="specGrid"></div>
                <div class="modal-price" id="modalPrice">💰 € 0</div>
            </div>
        </div>
    </div>

    <!-- Modal form progetto -->
    <div class="form-modal" id="formModal">
        <div class="form-content">
            <span class="modal-close" onclick="closeModal('formModal')">
                <i class="fas fa-times"></i>
            </span>
            <h2 class="form-title" id="formTitle">➕ Aggiungi Progetto</h2>
            <form id="gameForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="gameName">
                            <i class="fas fa-gamepad"></i> 🎮 Nome Progetto *
                        </label>
                        <input type="text" id="gameName" required placeholder="Game Boy Color Custom" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="gameCategory">
                            <i class="fas fa-tags"></i> 🏷️ Categoria *
                        </label>
                        <select id="gameCategory" required>
                            <option value="">Seleziona categoria</option>
                            <option value="color">🌈 Game Boy Color</option>
                            <option value="advance">📱 Game Boy Advance</option>
                            <option value="sp">💎 Game Boy Advance SP</option>
                        </select>
                    </div>
                </div>

                <div class="form-group full-width">
                    <label for="gameImages">
                        <i class="fas fa-images"></i> 🖼️ Immagini Progetto (Max 10) *
                    </label>
                    <div class="images-upload-container" id="imagesUploadContainer">
                        <input type="file" id="gameImages" class="images-input" accept="image/*" multiple>
                        <div class="upload-placeholder" id="uploadPlaceholder">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <div>📤 Carica immagini</div>
                            <small>JPG, PNG · Max 5MB · Max 10 immagini</small>
                        </div>
                        <div class="images-preview" id="imagesPreview"></div>
                        <div class="image-count" id="imageCount">0 / 10 immagini</div>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="gamePrice">
                            <i class="fas fa-euro-sign"></i> 💰 Prezzo *
                        </label>
                        <input type="number" id="gamePrice" step="0.01" min="0" required placeholder="120.00" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="gameModel">
                            <i class="fas fa-microchip"></i> 🔧 Modello Base *
                        </label>
                        <input type="text" id="gameModel" required placeholder="CGB-001" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="gameShell">
                            <i class="fas fa-mobile-alt"></i> 📱 Scocca
                        </label>
                        <input type="text" id="gameShell" placeholder="Trasparente custom" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="gameButtons">
                            <i class="fas fa-circle"></i> 🔘 Pulsanti
                        </label>
                        <input type="text" id="gameButtons" placeholder="Custom colorati" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="gameLabel">
                            <i class="fas fa-tag"></i> 🏷️ Etichetta
                        </label>
                        <input type="text" id="gameLabel" placeholder="Personalizzata" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="gameBattery">
                            <i class="fas fa-battery-full"></i> 🔋 Batteria
                        </label>
                        <input type="text" id="gameBattery" placeholder="Li-ion ricaricabile" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="gameAudio">
                            <i class="fas fa-volume-up"></i> 🔊 Audio
                        </label>
                        <input type="text" id="gameAudio" placeholder="Speaker + amplificatore" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="gameDisplay">
                            <i class="fas fa-tv"></i> 🖥️ Display
                        </label>
                        <input type="text" id="gameDisplay" placeholder="IPS retroilluminato" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="gameLed">
                            <i class="fas fa-lightbulb"></i> 💡 Kit LED
                        </label>
                        <input type="text" id="gameLed" placeholder="RGB programmabile" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="gameBox">
                            <i class="fas fa-box"></i> 📦 Accessori
                        </label>
                        <input type="text" id="gameBox" placeholder="Box + manuale" autocomplete="off">
                    </div>
                </div>
                
                <div class="form-group full-width">
                    <label for="gameOther">
                        <i class="fas fa-plus-circle"></i> ➕ Note Aggiuntive
                    </label>
                    <textarea id="gameOther" rows="3" placeholder="Modifiche speciali, personalizzazioni..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('formModal')">
                        <i class="fas fa-times"></i> ❌ Annulla
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> 💾 Salva
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configurazione ottimizzata
        const CONFIG = {
            ADMIN_PASSWORD: 'RetroAvia2024!',
            MAX_FILE_SIZE: 5 * 1024 * 1024, // 5MB
            MAX_IMAGES: 10,
            SUPABASE_URL: 'https://moenkmmkpogjapsyiuat.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vZW5rbW1rcG9namFwc3lpdWF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0OTYyMTYsImV4cCI6MjA3MjA3MjIxNn0.RdFnDxJVIgESel9I6s84KRR3F6yPFL7rk0ycFP_q0pg',
            SYNC_TIMEOUT: 30000, // 30 secondi
            RETRY_ATTEMPTS: 3,
            RETRY_DELAY: 2000, // 2 secondi
            TOAST_DURATION: 4000,
            SEARCH_DEBOUNCE: 300,
            IMAGE_COMPRESSION: {
                quality: 0.8,
                maxDimension: 1920
            }
        };
        
        // Stato globale
        const STATE = {
            supabase: null,
            games: [],
            editMode: false,
            currentCategory: 'all',
            editingId: null,
            isAuthenticated: false,
            searchQuery: '',
            sortBy: 'date-desc',
            currentSlide: 0,
            currentGameImages: [],
            uploadedImages: [],
            cloudSyncEnabled: true,
            isOnline: navigator.onLine
        };

        // Utility functions
        const Utils = {
            debounce: (func, wait) => {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            generateId: () => `game_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,

            formatDate: (dateString) => {
                return new Date(dateString).toLocaleDateString('it-IT', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            },

            formatPrice: (price) => {
                const num = parseFloat(price) || 0;
                return new Intl.NumberFormat('it-IT', {
                    style: 'currency',
                    currency: 'EUR'
                }).format(num);
            },

            sanitizeInput: (str) => {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },

            compressImage: (file, quality = CONFIG.IMAGE_COMPRESSION.quality, maxDim = CONFIG.IMAGE_COMPRESSION.maxDimension) => {
                return new Promise((resolve, reject) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = () => {
                        let { width, height } = img;
                        
                        const ratio = Math.min(maxDim / width, maxDim / height);
                        if (ratio < 1) {
                            width *= ratio;
                            height *= ratio;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const result = canvas.toDataURL('image/jpeg', quality);
                        resolve(result);
                    };
                    
                    img.onerror = reject;
                    img.src = URL.createObjectURL(file);
                });
            },

            fileToBase64: (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },

            async sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        };

        // Gestione Supabase con retry migliorato
        const SupabaseManager = {
            initialize: () => {
                try {
                    if (window.supabase && window.supabase.createClient) {
                        STATE.supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY, {
                            auth: {
                                persistSession: false
                            },
                            realtime: {
                                params: {
                                    eventsPerSecond: 2
                                }
                            }
                        });
                        return true;
                    }
                } catch (error) {
                    console.error('Errore inizializzazione Supabase:', error);
                    return false;
                }
                return false;
            },

            async makeRequest(operation, retries = CONFIG.RETRY_ATTEMPTS) {
                if (!STATE.isOnline) {
                    throw new Error('Connessione offline');
                }

                let lastError;
                for (let attempt = 0; attempt < retries; attempt++) {
                    try {
                        // Controller per timeout
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), CONFIG.SYNC_TIMEOUT);
                        
                        const result = await operation();
                        clearTimeout(timeoutId);
                        
                        if (result.error) {
                            throw result.error;
                        }
                        
                        return result;
                    } catch (error) {
                        lastError = error;
                        console.warn(`Tentativo ${attempt + 1} fallito:`, error.message);
                        
                        if (attempt < retries - 1) {
                            await Utils.sleep(CONFIG.RETRY_DELAY * (attempt + 1));
                        }
                    }
                }
                
                throw lastError;
            },

            syncToCloud: async (notify = false) => {
                if (!STATE.cloudSyncEnabled || !STATE.supabase || !STATE.isOnline) {
                    UI.updateSyncStatus('local', 'Offline');
                    return false;
                }

                try {
                    UI.updateSyncStatus('syncing', 'Sincronizzazione...');
                    
                    // Cancella dati esistenti
                    await SupabaseManager.makeRequest(async () => {
                        return await STATE.supabase
                            .from('games')
                            .delete()
                            .neq('id', 'none');
                    });

                    // Inserisce nuovi dati se presenti
                    if (STATE.games.length > 0) {
                        const gamesData = STATE.games.map(game => ({
                            id: game.id,
                            name: game.name,
                            category: game.category,
                            images: Array.isArray(game.images) ? game.images : [],
                            price: parseFloat(game.price) || 0,
                            model: game.model || '',
                            shell: game.shell || '',
                            buttons: game.buttons || '',
                            label: game.label || '',
                            battery: game.battery || '',
                            audio: game.audio || '',
                            display: game.display || '',
                            led: game.led || '',
                            box: game.box || '',
                            other: game.other || '',
                            created_at: game.createdAt,
                            updated_at: game.updatedAt || new Date().toISOString()
                        }));

                        await SupabaseManager.makeRequest(async () => {
                            return await STATE.supabase
                                .from('games')
                                .insert(gamesData);
                        });
                    }

                    localStorage.setItem('retroavia_last_sync', new Date().toISOString());
                    UI.updateSyncStatus('synced', `✅ Sincronizzato (${STATE.games.length})`);
                    
                    if (notify) {
                        UI.showToast('✅ Sincronizzazione completata con successo', 'success');
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Errore sincronizzazione:', error);
                    UI.updateSyncStatus('error', '❌ Errore sync');
                    
                    if (notify) {
                        const errorMsg = error.message.includes('fetch') ? 
                            'Problemi di connessione al server' : 
                            error.message;
                        UI.showToast(`❌ Errore sincronizzazione: ${errorMsg}`, 'error');
                    }
                    return false;
                }
            },

            syncFromCloud: async () => {
                if (!STATE.cloudSyncEnabled || !STATE.supabase || !STATE.isOnline) {
                    UI.updateSyncStatus('local', 'Offline');
                    return false;
                }

                try {
                    UI.updateSyncStatus('syncing', 'Caricamento...');
                    
                    const result = await SupabaseManager.makeRequest(async () => {
                        return await STATE.supabase
                            .from('games')
                            .select('*')
                            .order('created_at', { ascending: false });
                    });

                    const cloudGames = result.data;

                    if (cloudGames && cloudGames.length > 0) {
                        const convertedGames = cloudGames.map(game => ({
                            id: game.id,
                            name: game.name,
                            category: game.category,
                            images: Array.isArray(game.images) ? game.images : [],
                            price: parseFloat(game.price) || 0,
                            model: game.model || '',
                            shell: game.shell || '',
                            buttons: game.buttons || '',
                            label: game.label || '',
                            battery: game.battery || '',
                            audio: game.audio || '',
                            display: game.display || '',
                            led: game.led || '',
                            box: game.box || '',
                            other: game.other || '',
                            createdAt: game.created_at,
                            updatedAt: game.updated_at
                        }));

                        if (STATE.games.length === 0 || convertedGames.length > STATE.games.length) {
                            STATE.games = convertedGames;
                            DataManager.saveLocal();
                            UI.renderGallery();
                            UI.updateStats();
                        }
                        
                        localStorage.setItem('retroavia_last_sync', new Date().toISOString());
                        UI.updateSyncStatus('synced', `📥 Caricato (${STATE.games.length})`);
                    } else {
                        UI.updateSyncStatus('synced', '☁️ Cloud vuoto');
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Errore caricamento da cloud:', error);
                    UI.updateSyncStatus('error', '❌ Errore caricamento');
                    return false;
                }
            }
        };

        // Network status monitoring
        const NetworkManager = {
            init: () => {
                window.addEventListener('online', () => {
                    STATE.isOnline = true;
                    if (STATE.isAuthenticated && STATE.cloudSyncEnabled && STATE.supabase) {
                        SupabaseManager.syncFromCloud();
                    }
                });

                window.addEventListener('offline', () => {
                    STATE.isOnline = false;
                    UI.updateSyncStatus('local', 'Offline');
                });
            }
        };

        // Gestione dati - FIXED LOCAL SAVE ERROR
        const DataManager = {
            loadLocal: () => {
                try {
                    const saved = localStorage.getItem('retroavia_games');
                    if (saved) {
                        const parsedGames = JSON.parse(saved);
                        STATE.games = parsedGames.map(game => ({
                            id: game.id || Utils.generateId(),
                            name: game.name || 'Progetto',
                            category: game.category || 'color',
                            images: Array.isArray(game.images) ? game.images : [],
                            price: parseFloat(game.price) || 0,
                            model: game.model || '',
                            shell: game.shell || '',
                            buttons: game.buttons || '',
                            label: game.label || '',
                            battery: game.battery || '',
                            audio: game.audio || '',
                            display: game.display || '',
                            led: game.led || '',
                            box: game.box || '',
                            other: game.other || '',
                            createdAt: game.createdAt || new Date().toISOString(),
                            updatedAt: game.updatedAt || new Date().toISOString()
                        }));
                        
                        DataManager.sortGames();
                    }
                    
                    UI.renderGallery();
                    UI.updateStats();
                } catch (error) {
                    console.error('Errore caricamento locale:', error);
                    STATE.games = [];
                }
            },

            saveLocal: () => {
                try {
                    localStorage.setItem('retroavia_games', JSON.stringify(STATE.games));
                    return true;
                } catch (error) {
                    console.error('Errore salvataggio locale:', error);
                    // FIXED: Non mostrare più il toast di errore se il salvataggio è riuscito
                    // Il localStorage.setItem non lancia eccezione se riesce
                    if (error.name === 'QuotaExceededError') {
                        UI.showToast('❌ Spazio di archiviazione esaurito', 'error');
                    }
                    return false;
                }
            },

            filterGames: () => {
                let filtered = STATE.currentCategory === 'all' ? 
                    [...STATE.games] : 
                    STATE.games.filter(g => g.category === STATE.currentCategory);
                
                if (STATE.searchQuery) {
                    const query = STATE.searchQuery.toLowerCase();
                    filtered = filtered.filter(game => 
                        game.name.toLowerCase().includes(query) ||
                        game.model.toLowerCase().includes(query) ||
                        (game.shell && game.shell.toLowerCase().includes(query)) ||
                        (game.buttons && game.buttons.toLowerCase().includes(query)) ||
                        (game.display && game.display.toLowerCase().includes(query))
                    );
                }
                
                return DataManager.applySorting(filtered);
            },

            applySorting: (games) => {
                const sortedGames = [...games];
                
                switch (STATE.sortBy) {
                    case 'date-desc':
                        return sortedGames.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    case 'date-asc':
                        return sortedGames.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    case 'name-asc':
                        return sortedGames.sort((a, b) => a.name.localeCompare(b.name));
                    case 'name-desc':
                        return sortedGames.sort((a, b) => b.name.localeCompare(a.name));
                    case 'price-desc':
                        return sortedGames.sort((a, b) => b.price - a.price);
                    case 'price-asc':
                        return sortedGames.sort((a, b) => a.price - b.price);
                    default:
                        return sortedGames;
                }
            },

            sortGames: () => {
                STATE.games = DataManager.applySorting(STATE.games);
            }
        };

        // UI Manager
        const UI = {
            updateSyncStatus: (status, text) => {
                const syncStatus = document.getElementById('syncStatus');
                const syncIcon = document.getElementById('syncIcon');
                const syncText = document.getElementById('syncText');
                
                if (!syncStatus || !syncIcon || !syncText) return;
                
                syncStatus.style.display = STATE.isAuthenticated ? 'flex' : 'none';
                
                syncStatus.className = `sync-status ${status}`;
                syncText.textContent = text;
                
                switch(status) {
                    case 'syncing':
                        syncIcon.className = 'fas fa-sync-alt fa-spin';
                        break;
                    case 'synced':
                        syncIcon.className = 'fas fa-cloud-check';
                        break;
                    case 'error':
                        syncIcon.className = 'fas fa-cloud-exclamation';
                        break;
                    case 'local':
                        syncIcon.className = 'fas fa-hard-drive';
                        break;
                    default:
                        syncIcon.className = 'fas fa-cloud';
                }
            },

            updateAuthUI: () => {
                const elements = {
                    authStatus: document.getElementById('authStatus'),
                    authButton: document.getElementById('authButton'),
                    authIcon: document.getElementById('authIcon'),
                    authText: document.getElementById('authText'),
                    adminControls: document.getElementById('adminControls'),
                    syncStatus: document.getElementById('syncStatus')
                };

                if (STATE.isAuthenticated) {
                    elements.authStatus.className = 'auth-status logged-in';
                    elements.authIcon.className = 'fas fa-unlock';
                    elements.authText.textContent = '👑 Admin';
                    elements.authButton.innerHTML = '<i class="fas fa-sign-out-alt"></i> 🚪 Esci';
                    elements.authButton.className = 'auth-btn logout';
                    elements.adminControls.classList.add('show');
                    elements.syncStatus.style.display = 'flex';
                } else {
                    elements.authStatus.className = 'auth-status logged-out';
                    elements.authIcon.className = 'fas fa-lock';
                    elements.authText.textContent = '👤 Visitatore';
                    elements.authButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> 🔑 Accedi';
                    elements.authButton.className = 'auth-btn';
                    elements.adminControls.classList.remove('show');
                    elements.syncStatus.style.display = 'none';
                }
            },

            updateStats: () => {
                const total = STATE.games.length;
                const stats = {
                    total: total,
                    color: STATE.games.filter(g => g.category === 'color').length,
                    advance: STATE.games.filter(g => g.category === 'advance').length,
                    sp: STATE.games.filter(g => g.category === 'sp').length
                };

                Object.entries(stats).forEach(([key, value], index) => {
                    const element = document.getElementById(key === 'total' ? 'totalGames' : `${key}Games`);
                    if (element) {
                        setTimeout(() => {
                            UI.animateCounter(element, parseInt(element.textContent) || 0, value);
                        }, index * 100);
                    }
                });
            },

            animateCounter: (element, start, end, duration = 800) => {
                const range = end - start;
                const increment = range / (duration / 16);
                let current = start;
                
                const timer = setInterval(() => {
                    current += increment;
                    if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                        current = end;
                        clearInterval(timer);
                    }
                    element.textContent = Math.floor(current);
                }, 16);
            },

            switchCategory: (category, tabElement) => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                tabElement.classList.add('active');
                STATE.currentCategory = category;
                
                const titles = {
                    'all': '🌟 Tutti i Progetti',
                    'color': '🌈 Game Boy Color',
                    'advance': '📱 Game Boy Advance',
                    'sp': '💎 Game Boy Advance SP'
                };
                
                document.getElementById('galleryTitle').textContent = titles[category];
                UI.renderGallery();
            },

            renderGallery: () => {
                const gallery = document.getElementById('gallery');
                const filteredGames = DataManager.filterGames();

                if (filteredGames.length === 0) {
                    const message = STATE.searchQuery ? 
                        `🔍 Nessun risultato per "${STATE.searchQuery}"` : 
                        '🎮 Nessun progetto disponibile';
                    
                    const description = STATE.searchQuery ? 
                        '💡 Prova con altri termini di ricerca' : 
                        '✨ I progetti RetroAvia appariranno qui una volta aggiunti';
                    
                    gallery.innerHTML = `
                        <div class="empty-state fade-in">
                            <i class="fas fa-gamepad"></i>
                            <h3>${message}</h3>
                            <p>${description}</p>
                        </div>
                    `;
                    return;
                }

                gallery.innerHTML = filteredGames.map((game, index) => {
                    const date = Utils.formatDate(game.createdAt);
                    const imageCount = game.images ? game.images.length : 0;
                    const firstImage = imageCount > 0 ? game.images[0] : null;
                    const price = Utils.formatPrice(game.price);
                    
                    return `
                        <div class="game-card" 
                             onclick="showDetails('${game.id}')" 
                             style="--i: ${index}; animation-delay: ${index * 0.05}s">
                            ${STATE.editMode ? `
                                <div class="edit-controls">
                                    <button class="edit-btn" onclick="event.stopPropagation(); editGame('${game.id}')" title="✏️ Modifica">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="edit-btn delete" onclick="event.stopPropagation(); deleteGame('${game.id}')" title="🗑️ Elimina">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            ` : ''}
                            <div class="game-image-container">
                                ${firstImage ? 
                                    `<img src="${firstImage}" alt="${Utils.sanitizeInput(game.name)}" class="game-image" loading="lazy">` : 
                                    `<div class="game-placeholder"><i class="fas fa-gamepad"></i></div>`
                                }
                                ${imageCount > 1 ? `<div class="image-indicator">📸 ${imageCount} foto</div>` : ''}
                                <div class="game-date">📅 ${date}</div>
                            </div>
                            <div class="game-info">
                                <div class="game-title">${Utils.sanitizeInput(game.name)}</div>
                                <div class="game-model">🔧 ${Utils.sanitizeInput(game.model)}</div>
                                <div class="game-price">${price}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            showDetails: (id) => {
                if (STATE.editMode) return;
                
                const game = STATE.games.find(g => g.id === id);
                if (!game) return;

                document.getElementById('modalTitle').textContent = `🎮 ${game.name}`;
                document.getElementById('modalPrice').textContent = `💰 ${Utils.formatPrice(game.price)}`;
                
                STATE.currentGameImages = Array.isArray(game.images) ? game.images : [];
                STATE.currentSlide = 0;
                UI.updateModalGallery();

                const specs = [
                    { label: 'Modello', value: game.model, icon: 'microchip', emoji: '🔧' },
                    { label: 'Scocca', value: game.shell, icon: 'mobile-alt', emoji: '📱' },
                    { label: 'Pulsanti', value: game.buttons, icon: 'circle', emoji: '🔘' },
                    { label: 'Etichetta', value: game.label, icon: 'tag', emoji: '🏷️' },
                    { label: 'Batteria', value: game.battery, icon: 'battery-full', emoji: '🔋' },
                    { label: 'Audio', value: game.audio, icon: 'volume-up', emoji: '🔊' },
                    { label: 'Display', value: game.display, icon: 'tv', emoji: '🖥️' },
                    { label: 'LED', value: game.led, icon: 'lightbulb', emoji: '💡' },
                    { label: 'Accessori', value: game.box, icon: 'box', emoji: '📦' },
                    { label: 'Note', value: game.other, icon: 'plus-circle', emoji: '📝' }
                ].filter(spec => spec.value && spec.value.trim() !== '');

                document.getElementById('specGrid').innerHTML = specs.map((spec, index) => `
                    <div class="spec-item slide-up" style="animation-delay: ${index * 0.1}s">
                        <div class="spec-label">
                            <i class="fas fa-${spec.icon}"></i> ${spec.emoji} ${spec.label}
                        </div>
                        <div class="spec-value">${Utils.sanitizeInput(spec.value)}</div>
                    </div>
                `).join('');

                document.getElementById('detailModal').style.display = 'block';
                document.body.style.overflow = 'hidden';
            },

            updateModalGallery: () => {
                const container = document.getElementById('galleryContainerModal');
                const counter = document.getElementById('galleryCounter');
                const indicators = document.getElementById('galleryIndicators');
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                
                const showControls = STATE.currentGameImages.length > 1;
                if (prevBtn) prevBtn.style.display = showControls ? 'flex' : 'none';
                if (nextBtn) nextBtn.style.display = showControls ? 'flex' : 'none';
                if (indicators) indicators.style.display = showControls ? 'flex' : 'none';
                
                if (STATE.currentGameImages.length === 0) {
                    container.innerHTML = `
                        <div class="gallery-slide">
                            <div class="modal-image-placeholder">
                                <i class="fas fa-gamepad"></i>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = STATE.currentGameImages.map((img, index) => `
                    <div class="gallery-slide">
                        <img src="${img}" alt="🎮 Game Boy ${index + 1}" class="modal-image" loading="lazy">
                    </div>
                `).join('');
                
                container.style.transform = `translateX(-${STATE.currentSlide * 100}%)`;
                
                if (counter) {
                    counter.textContent = `📸 ${STATE.currentSlide + 1} / ${STATE.currentGameImages.length}`;
                }
                
                if (indicators && showControls) {
                    indicators.innerHTML = STATE.currentGameImages.map((_, index) => `
                        <div class="gallery-dot ${index === STATE.currentSlide ? 'active' : ''}" 
                             onclick="goToSlide(${index})"></div>
                    `).join('');
                }
            },

            changeSlide: (direction) => {
                if (STATE.currentGameImages.length <= 1) return;
                STATE.currentSlide = (STATE.currentSlide + direction + STATE.currentGameImages.length) % STATE.currentGameImages.length;
                UI.updateModalGallery();
            },

            goToSlide: (index) => {
                if (index >= 0 && index < STATE.currentGameImages.length) {
                    STATE.currentSlide = index;
                    UI.updateModalGallery();
                }
            },

            showLoading: (text = 'Caricamento...') => {
                const loading = document.getElementById('loading');
                const loadingText = document.querySelector('.loading-text');
                if (loading) loading.style.display = 'flex';
                if (loadingText) loadingText.textContent = text;
            },

            hideLoading: () => {
                const loading = document.getElementById('loading');
                if (loading) loading.style.display = 'none';
            },

            showToast: (message, type = 'success') => {
                // Rimuovi toast esistenti
                document.querySelectorAll('.toast').forEach(toast => toast.remove());

                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `<i class="fas fa-${UI.getToastIcon(type)}"></i> ${message}`;
                document.body.appendChild(toast);
                
                // Auto-remove
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.style.animation = 'slideOutRight 0.3s ease forwards';
                        setTimeout(() => toast.remove(), 300);
                    }
                }, CONFIG.TOAST_DURATION);

                // Click to dismiss
                toast.addEventListener('click', () => {
                    toast.style.animation = 'slideOutRight 0.3s ease forwards';
                    setTimeout(() => toast.remove(), 300);
                });
            },

            getToastIcon: (type) => {
                const icons = {
                    success: 'check-circle',
                    error: 'exclamation-triangle',
                    info: 'info-circle',
                    warning: 'exclamation-circle'
                };
                return icons[type] || 'info-circle';
            },

            closeModal: (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                    
                    if (modalId === 'formModal') {
                        FormManager.reset();
                        STATE.editingId = null;
                    }
                }
            }
        };

        // Form Manager ottimizzato
        const FormManager = {
            reset: () => {
                const form = document.getElementById('gameForm');
                if (form) form.reset();
                STATE.uploadedImages = [];
                FormManager.updateImagesPreview();
            },

            openAdd: () => {
                if (!STATE.isAuthenticated) {
                    UI.showToast('🔒 Accesso amministratore richiesto', 'error');
                    return;
                }
                
                STATE.editingId = null;
                document.getElementById('formTitle').textContent = '➕ Aggiungi Progetto';
                FormManager.reset();
                document.getElementById('formModal').style.display = 'block';
                document.body.style.overflow = 'hidden';
                
                setTimeout(() => {
                    document.getElementById('gameName')?.focus();
                }, 100);
            },

            editGame: (id) => {
                if (!STATE.isAuthenticated) return;
                
                const game = STATE.games.find(g => g.id === id);
                if (!game) return;

                STATE.editingId = id;
                document.getElementById('formTitle').textContent = '✏️ Modifica Progetto';
                
                const fields = [
                    'gameName', 'gameCategory', 'gamePrice', 'gameModel', 'gameShell', 
                    'gameButtons', 'gameLabel', 'gameBattery', 'gameAudio', 'gameDisplay', 
                    'gameLed', 'gameBox', 'gameOther'
                ];
                const gameKeys = [
                    'name', 'category', 'price', 'model', 'shell', 'buttons', 
                    'label', 'battery', 'audio', 'display', 'led', 'box', 'other'
                ];
                
                fields.forEach((fieldId, i) => {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        element.value = game[gameKeys[i]] || '';
                    }
                });
                
                STATE.uploadedImages = (game.images || []).map((img, i) => ({
                    data: img,
                    name: `🖼️ Immagine ${i + 1}`,
                    size: 0
                }));
                FormManager.updateImagesPreview();
                
                document.getElementById('formModal').style.display = 'block';
                document.body.style.overflow = 'hidden';
            },

            handleSubmit: async (e) => {
                e.preventDefault();
                
                if (!STATE.isAuthenticated || STATE.uploadedImages.length === 0) {
                    UI.showToast('📸 Aggiungi almeno un\'immagine al progetto', 'error');
                    return;
                }

                const formData = FormManager.getFormData();
                if (!FormManager.validateFormData(formData)) {
                    return;
                }

                UI.showLoading('💾 Salvataggio progetto...');

                try {
                    const gameData = {
                        id: STATE.editingId || Utils.generateId(),
                        ...formData,
                        images: STATE.uploadedImages.map(img => img.data),
                        createdAt: STATE.editingId ? 
                            (STATE.games.find(g => g.id === STATE.editingId)?.createdAt || new Date().toISOString()) : 
                            new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };

                    if (STATE.editingId) {
                        const index = STATE.games.findIndex(g => g.id === STATE.editingId);
                        if (index !== -1) {
                            STATE.games[index] = gameData;
                            UI.showToast('✅ Progetto aggiornato con successo', 'success');
                        }
                    } else {
                        STATE.games.unshift(gameData);
                        UI.showToast('🎉 Nuovo progetto aggiunto con successo', 'success');
                    }

                    DataManager.saveLocal();
                    if (STATE.cloudSyncEnabled && STATE.supabase && STATE.isOnline) {
                        await SupabaseManager.syncToCloud(false);
                    }
                    
                    UI.closeModal('formModal');
                    UI.renderGallery();
                    UI.updateStats();
                    
                } catch (error) {
                    console.error('Errore salvataggio:', error);
                    UI.showToast('❌ Errore durante il salvataggio', 'error');
                } finally {
                    UI.hideLoading();
                }
            },

            getFormData: () => {
                return {
                    name: document.getElementById('gameName').value.trim(),
                    category: document.getElementById('gameCategory').value,
                    price: parseFloat(document.getElementById('gamePrice').value) || 0,
                    model: document.getElementById('gameModel').value.trim(),
                    shell: document.getElementById('gameShell').value.trim(),
                    buttons: document.getElementById('gameButtons').value.trim(),
                    label: document.getElementById('gameLabel').value.trim(),
                    battery: document.getElementById('gameBattery').value.trim(),
                    audio: document.getElementById('gameAudio').value.trim(),
                    display: document.getElementById('gameDisplay').value.trim(),
                    led: document.getElementById('gameLed').value.trim(),
                    box: document.getElementById('gameBox').value.trim(),
                    other: document.getElementById('gameOther').value.trim()
                };
            },

            validateFormData: (data) => {
                if (!data.name) {
                    UI.showToast('🎮 Il nome del progetto è obbligatorio', 'error');
                    document.getElementById('gameName')?.focus();
                    return false;
                }
                
                if (!data.category) {
                    UI.showToast('🏷️ Seleziona una categoria', 'error');
                    document.getElementById('gameCategory')?.focus();
                    return false;
                }
                
                if (!data.model) {
                    UI.showToast('🔧 Il modello base è obbligatorio', 'error');
                    document.getElementById('gameModel')?.focus();
                    return false;
                }
                
                if (data.price < 0) {
                    UI.showToast('💰 Il prezzo non può essere negativo', 'error');
                    document.getElementById('gamePrice')?.focus();
                    return false;
                }
                
                return true;
            },

            handleImagesSelect: (e) => {
                const files = Array.from(e.target.files);
                FormManager.processImages(files);
            },

            handleImagesDrop: (e) => {
                e.preventDefault();
                e.currentTarget.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files).filter(f => f.type.match('image.*'));
                FormManager.processImages(files);
            },

            processImages: async (files) => {
                if (STATE.uploadedImages.length + files.length > CONFIG.MAX_IMAGES) {
                    UI.showToast(`📸 Massimo ${CONFIG.MAX_IMAGES} immagini consentite`, 'error');
                    return;
                }

                if (files.length === 0) return;

                UI.showLoading('🖼️ Elaborazione immagini...');
                
                const results = [];
                for (const file of files) {
                    try {
                        if (!file.type.match('image.*')) {
                            continue;
                        }
                        
                        if (file.size > CONFIG.MAX_FILE_SIZE) {
                            UI.showToast(`📦 File ${file.name} troppo grande (max 5MB)`, 'error');
                            continue;
                        }

                        let finalData;
                        if (file.size > 1024 * 1024) {
                            finalData = await Utils.compressImage(file);
                        } else {
                            finalData = await Utils.fileToBase64(file);
                        }

                        results.push({
                            data: finalData,
                            name: file.name,
                            size: file.size
                        });
                    } catch (error) {
                        console.error('Errore elaborazione immagine:', file.name, error);
                    }
                }

                STATE.uploadedImages.push(...results);
                FormManager.updateImagesPreview();
                UI.hideLoading();
                
                if (results.length > 0) {
                    UI.showToast(`🖼️ ${results.length} immagini elaborate con successo`, 'success');
                }
            },

            updateImagesPreview: () => {
                const preview = document.getElementById('imagesPreview');
                const counter = document.getElementById('imageCount');
                const placeholder = document.getElementById('uploadPlaceholder');
                
                if (!preview || !counter || !placeholder) return;
                
                counter.textContent = `📸 ${STATE.uploadedImages.length} / ${CONFIG.MAX_IMAGES} immagini`;
                
                if (STATE.uploadedImages.length === 0) {
                    preview.innerHTML = '';
                    placeholder.style.display = 'block';
                    return;
                }

                placeholder.style.display = 'none';
                preview.innerHTML = STATE.uploadedImages.map((img, index) => `
                    <div class="image-preview-item" style="animation-delay: ${index * 0.1}s">
                        <img src="${img.data}" alt="${img.name}" class="image-preview-img" loading="lazy">
                        <button type="button" class="image-remove" 
                                onclick="FormManager.removeImage(${index})" 
                                title="🗑️ Rimuovi immagine">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('');
            },

            removeImage: (index) => {
                STATE.uploadedImages.splice(index, 1);
                FormManager.updateImagesPreview();
                UI.showToast('🗑️ Immagine rimossa', 'info');
            }
        };

        // Auth Manager ottimizzato
        const AuthManager = {
            showModal: () => {
                if (STATE.isAuthenticated) {
                    AuthManager.logout();
                } else {
                    document.getElementById('authModal').style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    setTimeout(() => {
                        document.getElementById('authPassword')?.focus();
                    }, 100);
                }
            },

            closeModal: () => {
                document.getElementById('authModal').style.display = 'none';
                document.body.style.overflow = '';
                document.body.classList.remove('modal-open');
                document.getElementById('authPassword').value = '';
            },

            authenticate: () => {
                const password = document.getElementById('authPassword');
                if (password.value === CONFIG.ADMIN_PASSWORD) {
                    STATE.isAuthenticated = true;
                    UI.updateAuthUI();
                    AuthManager.closeModal();
                    UI.showToast('🎉 Accesso amministratore effettuato', 'success');
                    
                    if (STATE.cloudSyncEnabled && STATE.supabase && STATE.isOnline) {
                        SupabaseManager.syncFromCloud();
                    }
                } else {
                    UI.showToast('❌ Password non corretta', 'error');
                    password.value = '';
                    password.focus();
                    
                    password.style.animation = 'shake 0.5s ease-in-out';
                    setTimeout(() => {
                        password.style.animation = '';
                    }, 500);
                }
            },

            logout: () => {
                STATE.isAuthenticated = false;
                STATE.editMode = false;
                UI.updateAuthUI();
                UI.renderGallery();
                UI.showToast('👋 Disconnesso dalla modalità admin', 'info');
            }
        };

        // Admin Manager ottimizzato
        const AdminManager = {
            toggleEditMode: () => {
                if (!STATE.isAuthenticated) {
                    UI.showToast('🔒 Accesso amministratore richiesto', 'error');
                    return;
                }
                
                STATE.editMode = !STATE.editMode;
                const btn = document.getElementById('editModeBtn');
                
                if (STATE.editMode) {
                    btn.innerHTML = '<i class="fas fa-times"></i> ❌ Esci';
                    btn.classList.add('edit-mode');
                    UI.showToast('✏️ Modalità modifica attiva', 'info');
                } else {
                    btn.innerHTML = '<i class="fas fa-edit"></i> ✏️ Modifica';
                    btn.classList.remove('edit-mode');
                    UI.showToast('👁️ Modalità visualizzazione ripristinata', 'info');
                }
                
                UI.renderGallery();
            },

            deleteGame: (id) => {
                if (!STATE.isAuthenticated) return;
                
                const game = STATE.games.find(g => g.id === id);
                if (!game) return;
                
                if (confirm(`🗑️ Sei sicuro di voler eliminare "${game.name}"?\n\n⚠️ Questa operazione non può essere annullata.`)) {
                    STATE.games = STATE.games.filter(g => g.id !== id);
                    DataManager.saveLocal();
                    
                    if (STATE.cloudSyncEnabled && STATE.supabase && STATE.isOnline) {
                        SupabaseManager.syncToCloud(false);
                    }
                    
                    UI.renderGallery();
                    UI.updateStats();
                    UI.showToast('🗑️ Progetto eliminato', 'success');
                }
            },

            exportData: () => {
                if (!STATE.isAuthenticated) return;
                
                if (STATE.games.length === 0) {
                    UI.showToast('📦 Nessun dato da esportare', 'error');
                    return;
                }
                
                const exportData = {
                    version: '2.2.0',
                    exportDate: new Date().toISOString(),
                    totalGames: STATE.games.length,
                    games: STATE.games
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `retroavia_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                UI.showToast(`📥 ${STATE.games.length} progetti esportati`, 'success');
            },

            importData: () => {
                if (!STATE.isAuthenticated) return;
                
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.style.display = 'none';
                
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    UI.showLoading('📤 Importazione dati...');
                    
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            let importedGames = Array.isArray(importedData) ? 
                                importedData : 
                                importedData.games || [];
                            
                            if (importedGames.length === 0) {
                                throw new Error('Nessun progetto valido trovato nel file');
                            }

                            const replace = STATE.games.length > 0 ? 
                                confirm(`🔄 Vuoi sostituire i ${STATE.games.length} progetti esistenti con i ${importedGames.length} progetti importati?\n\nClicca "OK" per sostituire, "Annulla" per aggiungere.`) :
                                true;
                            
                            if (replace) {
                                STATE.games = importedGames;
                            } else {
                                importedGames.forEach(game => {
                                    if (!STATE.games.find(g => g.id === game.id)) {
                                        STATE.games.push(game);
                                    }
                                });
                            }
                            
                            DataManager.sortGames();
                            DataManager.saveLocal();
                            
                            if (STATE.cloudSyncEnabled && STATE.supabase && STATE.isOnline) {
                                await SupabaseManager.syncToCloud(false);
                            }
                            
                            UI.renderGallery();
                            UI.updateStats();
                            UI.showToast(`📤 ${importedGames.length} progetti importati`, 'success');
                            
                        } catch (error) {
                            console.error('Errore importazione:', error);
                            UI.showToast('❌ File non valido o corrotto', 'error');
                        } finally {
                            UI.hideLoading();
                        }
                    };
                    reader.readAsText(file);
                };
                
                document.body.appendChild(input);
                input.click();
                document.body.removeChild(input);
            },

            clearAllData: () => {
                if (!STATE.isAuthenticated) return;
                
                if (STATE.games.length === 0) {
                    UI.showToast('📦 Nessun dato da eliminare', 'info');
                    return;
                }

                const confirmation = prompt(
                    `⚠️ ATTENZIONE ⚠️\n\nStai per eliminare PERMANENTEMENTE tutti i ${STATE.games.length} progetti.\n\n🚨 Questa operazione NON può essere annullata.\n\nPer confermare, scrivi esattamente: ELIMINA TUTTO`
                );
                
                if (confirmation === 'ELIMINA TUTTO') {
                    STATE.games = [];
                    DataManager.saveLocal();
                    
                    if (STATE.cloudSyncEnabled && STATE.supabase && STATE.isOnline) {
                        SupabaseManager.syncToCloud(false);
                    }
                    
                    UI.renderGallery();
                    UI.updateStats();
                    UI.showToast('🗑️ Tutti i dati sono stati eliminati', 'success');
                } else if (confirmation !== null) {
                    UI.showToast('❌ Testo di conferma non corretto', 'error');
                }
            }
        };

        // Event Handlers ottimizzati
        const EventHandlers = {
            setupAll: () => {
                EventHandlers.setupNavigation();
                EventHandlers.setupForm();
                EventHandlers.setupSearch();
                EventHandlers.setupAuth();
                EventHandlers.setupModals();
                EventHandlers.setupKeyboard();
            },

            setupNavigation: () => {
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        UI.switchCategory(tab.dataset.category, tab);
                    });
                });

                const sortDropdown = document.getElementById('sortDropdown');
                if (sortDropdown) {
                    sortDropdown.addEventListener('change', (e) => {
                        STATE.sortBy = e.target.value;
                        UI.renderGallery();
                    });
                }
            },

            setupForm: () => {
                const gameForm = document.getElementById('gameForm');
                if (gameForm) {
                    gameForm.addEventListener('submit', FormManager.handleSubmit);
                }

                const gameImages = document.getElementById('gameImages');
                if (gameImages) {
                    gameImages.addEventListener('change', FormManager.handleImagesSelect);
                }
                
                const uploadContainer = document.getElementById('imagesUploadContainer');
                if (uploadContainer) {
                    uploadContainer.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.currentTarget.classList.add('dragover');
                    });
                    
                    uploadContainer.addEventListener('dragleave', (e) => {
                        e.currentTarget.classList.remove('dragover');
                    });
                    
                    uploadContainer.addEventListener('drop', FormManager.handleImagesDrop);
                }
            },

            setupSearch: () => {
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    const debouncedSearch = Utils.debounce((query) => {
                        STATE.searchQuery = query.toLowerCase().trim();
                        UI.renderGallery();
                    }, CONFIG.SEARCH_DEBOUNCE);
                    
                    searchInput.addEventListener('input', (e) => {
                        debouncedSearch(e.target.value);
                    });
                }
            },

            setupAuth: () => {
                const authPassword = document.getElementById('authPassword');
                if (authPassword) {
                    authPassword.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            AuthManager.authenticate();
                        }
                    });
                }
            },

            setupModals: () => {
                window.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal') || 
                        e.target.classList.contains('form-modal') || 
                        e.target.classList.contains('auth-modal')) {
                        UI.closeModal(e.target.id);
                    }
                });
            },

            setupKeyboard: () => {
                document.addEventListener('keydown', (e) => {
                    switch(e.key) {
                        case 'Escape':
                            UI.closeModal('detailModal');
                            UI.closeModal('formModal');
                            AuthManager.closeModal();
                            break;
                        case 'ArrowLeft':
                            if (document.getElementById('detailModal').style.display === 'block') {
                                UI.changeSlide(-1);
                                e.preventDefault();
                            }
                            break;
                        case 'ArrowRight':
                            if (document.getElementById('detailModal').style.display === 'block') {
                                UI.changeSlide(1);
                                e.preventDefault();
                            }
                            break;
                    }
                });
            }
        };

        // App Initialization ottimizzata
        const App = {
            initialize: () => {
                UI.updateSyncStatus('syncing', '🔄 Inizializzazione...');
                
                // Inizializza network monitoring
                NetworkManager.init();
                
                let attempts = 0;
                const maxAttempts = 5;
                
                const tryInit = () => {
                    attempts++;
                    if (SupabaseManager.initialize()) {
                        App.start();
                        return;
                    }
                    
                    if (attempts < maxAttempts) {
                        setTimeout(tryInit, 200);
                    } else {
                        STATE.cloudSyncEnabled = false;
                        App.start();
                    }
                };
                
                setTimeout(tryInit, 100);
            },

            start: () => {
                DataManager.loadLocal();
                EventHandlers.setupAll();
                UI.updateStats();
                UI.updateAuthUI();
                
                if (STATE.cloudSyncEnabled && STATE.supabase && STATE.isOnline) {
                    SupabaseManager.syncFromCloud();
                } else {
                    UI.updateSyncStatus('local', STATE.isOnline ? '💻 Modalità offline' : '📴 Offline');
                }

                setTimeout(() => {
                    UI.hideLoading();
                }, 500);
            }
        };

        // Global functions per HTML onclick
        window.showAuthModal = AuthManager.showModal;
        window.closeAuthModal = AuthManager.closeModal;
        window.authenticate = AuthManager.authenticate;
        window.openAddModal = FormManager.openAdd;
        window.toggleEditMode = AdminManager.toggleEditMode;
        window.forceSyncData = () => {
            if (!STATE.isAuthenticated) {
                UI.showToast('🔒 Accesso amministratore richiesto', 'error');
                return;
            }
            if (!STATE.isOnline) {
                UI.showToast('📴 Connessione offline', 'error');
                return;
            }
            SupabaseManager.syncToCloud(true);
        };
        window.exportData = AdminManager.exportData;
        window.importData = AdminManager.importData;
        window.clearAllData = AdminManager.clearAllData;
        window.closeModal = UI.closeModal;
        window.changeSlide = UI.changeSlide;
        window.goToSlide = UI.goToSlide;
        window.showDetails = UI.showDetails;
        window.editGame = (id) => {
            if (!STATE.isAuthenticated) {
                UI.showToast('🔒 Accesso amministratore richiesto', 'error');
                return;
            }
            FormManager.editGame(id);
        };
        window.deleteGame = (id) => {
            if (!STATE.isAuthenticated) {
                UI.showToast('🔒 Accesso amministratore richiesto', 'error');
                return;
            }
            AdminManager.deleteGame(id);
        };
        window.removeImage = FormManager.removeImage;

        // Inizializzazione app
        document.addEventListener('DOMContentLoaded', App.initialize);
    </script>
</body>
</html>
